<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, user-scalable=yes">
    <meta name="theme-color" content="#0a5f4f">
    <meta name="mobile-web-app-capable" content="yes">
    <title>Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø© - Ø§Ø³Ø£Ù„ Ø§Ù„Ø¥Ø³Ù„Ø§Ù… AI</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=IBM+Plex+Sans+Arabic:wght@100;200;300;400;500;600;700&family=Amiri+Quran&display=swap" rel="stylesheet">
    <style>
        * { 
            margin: 0; 
            padding: 0; 
            box-sizing: border-box; 
        }
        
        :root { 
            --primary: #0a5f4f; 
            --secondary: #2d8b74; 
            --gold: #d4a574; 
            --dark: #1a1a1a; 
            --light: #f5f5f5; 
            --quran-color: #ffd700;
            --sidebar-width: 320px;
        }
        
        body { 
            font-family: "IBM Plex Sans Arabic", sans-serif; 
            background: linear-gradient(135deg, #0a5f4f 0%, #1a4a3d 50%, #2d8b74 100%); 
            color: #fff; 
            overflow: hidden; 
            position: relative; 
            height: 100vh; 
            margin: 0;
        }
        
        .glass { 
            background: rgba(255, 255, 255, 0.08); 
            backdrop-filter: blur(20px); 
            border: 1px solid rgba(255, 255, 255, 0.15); 
            border-radius: 24px; 
        }
        
        .container { 
            display: flex; 
            height: 100vh; 
            padding: 20px; 
            gap: 20px; 
            position: relative; 
            z-index: 1; 
        }
        
        /* Sidebar Styles */
        .sidebar { 
            width: var(--sidebar-width);
            display: flex; 
            flex-direction: column; 
            padding: 1.5rem; 
            transition: transform 0.3s ease;
            position: relative;
            overflow: hidden;
        }
        
        .sidebar.collapsed {
            transform: translateX(calc(var(--sidebar-width) + 20px));
        }
        
        .sidebar-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 2rem;
        }
        
        .sidebar-title {
            color: var(--gold);
            font-family: 'Amiri Quran';
            font-size: 1.3rem;
        }
        
        .toggle-btn {
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            color: white;
            width: 40px;
            height: 40px;
            border-radius: 12px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
            font-size: 1.2rem;
        }
        
        .toggle-btn:hover {
            background: rgba(255, 255, 255, 0.15);
            transform: scale(1.05);
        }
        
        .new-chat-btn {
            background: var(--gold);
            color: var(--dark);
            border: none;
            border-radius: 12px;
            padding: 0.9rem;
            cursor: pointer;
            font-weight: bold;
            font-size: 1rem;
            transition: all 0.3s ease;
            margin-bottom: 1.5rem;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
        }
        
        .new-chat-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(212, 165, 116, 0.4);
        }
        
        .chats-container {
            flex: 1;
            overflow-y: auto;
            padding-right: 0.5rem;
        }
        
        .chats-container::-webkit-scrollbar {
            width: 6px;
        }
        
        .chats-container::-webkit-scrollbar-track {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 10px;
        }
        
        .chats-container::-webkit-scrollbar-thumb {
            background: rgba(212, 165, 116, 0.5);
            border-radius: 10px;
        }
        
        .chat-item {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 12px;
            padding: 1rem;
            margin-bottom: 0.8rem;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
        }
        
        .chat-item:hover {
            background: rgba(255, 255, 255, 0.1);
            border-color: var(--gold);
            transform: translateX(-5px);
        }
        
        .chat-item.active {
            background: rgba(212, 165, 116, 0.2);
            border-color: var(--gold);
        }
        
        .chat-title {
            font-size: 0.95rem;
            margin-bottom: 0.3rem;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        
        .chat-time {
            font-size: 0.75rem;
            color: rgba(255, 255, 255, 0.6);
        }
        
        .delete-chat-btn {
            position: absolute;
            top: 50%;
            left: 10px;
            transform: translateY(-50%);
            background: rgba(255, 0, 0, 0.3);
            border: none;
            color: white;
            width: 30px;
            height: 30px;
            border-radius: 8px;
            cursor: pointer;
            opacity: 0;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .chat-item:hover .delete-chat-btn {
            opacity: 1;
        }
        
        .delete-chat-btn:hover {
            background: rgba(255, 0, 0, 0.6);
        }
        
        /* Floating Toggle Button (when sidebar is collapsed) */
        .floating-toggle {
            position: fixed;
            top: 30px;
            right: 30px;
            background: var(--gold);
            color: var(--dark);
            width: 50px;
            height: 50px;
            border-radius: 50%;
            border: none;
            cursor: pointer;
            display: none;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            box-shadow: 0 5px 20px rgba(212, 165, 116, 0.4);
            transition: all 0.3s ease;
            z-index: 1000;
        }
        
        .floating-toggle.show {
            display: flex;
        }
        
        .floating-toggle:hover {
            transform: scale(1.1);
        }
        
        /* Ø¥Ø®ÙØ§Ø¡ Sidebar Ø¹Ù„Ù‰ Ø§Ù„Ù‡ÙˆØ§ØªÙ */
        @media (max-width: 768px) {
            .sidebar {
                display: none !important;
            }
            
            .floating-toggle {
                display: none !important;
            }
            
            .container {
                padding: 10px;
            }
        }
        
        .main-content { 
            flex: 1; 
            display: flex; 
            flex-direction: column;
            transition: all 0.3s ease;
        }
        
        .main-content.expanded {
            margin-right: calc(-1 * var(--sidebar-width) - 20px);
        }
        
        .chat-area { 
            flex: 1; 
            overflow-y: auto; 
            padding: 2rem; 
            scroll-behavior: smooth; 
        }
        
        .chat-area::-webkit-scrollbar {
            width: 8px;
        }
        
        .chat-area::-webkit-scrollbar-track {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 10px;
        }
        
        .chat-area::-webkit-scrollbar-thumb {
            background: rgba(212, 165, 116, 0.5);
            border-radius: 10px;
        }
        
        .message { 
            margin-bottom: 2rem; 
            display: flex; 
            flex-direction: column; 
        }
        
        .message-content { 
            max-width: 85%; 
            padding: 1.5rem; 
            border-radius: 18px; 
            line-height: 1.8; 
            font-size: 1.05rem; 
            position: relative; 
        }
        
        .user-message { 
            align-self: flex-start; 
        }
        
        .user-message .message-content { 
            background: var(--gold); 
            color: var(--dark); 
            border-bottom-right-radius: 4px; 
        }
        
        .assistant-message { 
            align-self: flex-start; 
        }
        
        .assistant-message .message-content { 
            background: rgba(255, 255, 255, 0.1); 
            border: 1px solid rgba(255, 255, 255, 0.1); 
            border-bottom-left-radius: 4px; 
        }
        
        /* ØªÙ†Ø³ÙŠÙ‚ Ø§Ù„Ø¢ÙŠØ§Øª Ø§Ù„Ù‚Ø±Ø¢Ù†ÙŠØ© */
        .quran-verse {
            font-family: 'Amiri Quran', serif;
            color: var(--quran-color);
            font-size: 1.15em;
            line-height: 2;
            background: linear-gradient(135deg, rgba(255, 215, 0, 0.1), rgba(212, 165, 116, 0.1));
            padding: 0.5rem 1rem;
            border-radius: 12px;
            border-right: 3px solid var(--gold);
            display: inline-block;
            margin: 0.5rem 0;
            box-shadow: 0 2px 8px rgba(255, 215, 0, 0.2);
        }
        
        .message-source { 
            font-size: 0.85rem; 
            color: var(--gold); 
            margin-top: 0.8rem; 
            font-weight: 500; 
            display: flex; 
            align-items: center; 
            gap: 0.5rem;
            padding: 0.5rem;
            background: rgba(212, 165, 116, 0.1);
            border-radius: 8px;
        }
        
        .similar-questions { 
            display: flex; 
            flex-wrap: wrap; 
            gap: 0.8rem; 
            margin-top: 1.2rem; 
        }
        
        .q-chip { 
            background: rgba(255, 255, 255, 0.05); 
            border: 1px solid rgba(255, 255, 255, 0.1); 
            padding: 0.6rem 1.2rem; 
            border-radius: 50px; 
            font-size: 0.9rem; 
            cursor: pointer; 
            transition: all 0.3s ease; 
        }
        
        .q-chip:hover { 
            background: rgba(212, 165, 116, 0.2); 
            border-color: var(--gold); 
            transform: translateY(-2px);
        }
        
        .input-area { 
            padding: 1.5rem 2rem; 
            border-top: 1px solid rgba(255, 255, 255, 0.1); 
        }
        
        .input-wrapper { 
            display: flex; 
            gap: 1rem; 
            padding: 1rem; 
            border-radius: 20px; 
            align-items: center; 
        }
        
        textarea { 
            flex: 1; 
            background: transparent; 
            border: none; 
            color: white; 
            outline: none; 
            resize: none; 
            font-size: 1rem; 
            padding: 5px; 
            font-family: inherit;
            max-height: 150px;
        }
        
        textarea::placeholder {
            color: rgba(255, 255, 255, 0.5);
        }
        
        .send-btn { 
            background: var(--gold); 
            color: var(--dark); 
            border: none; 
            border-radius: 12px; 
            padding: 0.8rem 1.5rem; 
            cursor: pointer; 
            font-weight: bold; 
            transition: all 0.3s ease;
            font-family: inherit;
        }
        
        .send-btn:hover:not(:disabled) { 
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(212, 165, 116, 0.4);
        }
        
        .send-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        .typing-indicator { 
            display: none; 
            padding: 1rem; 
            color: var(--gold); 
            font-size: 0.9rem; 
        }
        
        .typing-indicator.active { 
            display: block; 
        }

        .warning-message {
            background: rgba(255, 100, 100, 0.2);
            border: 1px solid rgba(255, 100, 100, 0.4);
            padding: 1rem;
            border-radius: 12px;
            margin-top: 0.5rem;
            font-size: 0.9rem;
        }

        /* Responsive Design */
        @media (max-width: 768px) {
            .container {
                padding: 10px;
            }
            
            .sidebar {
                position: fixed;
                top: 0;
                right: 0;
                height: 100vh;
                z-index: 100;
                padding-top: 70px;
            }
            
            .sidebar.collapsed {
                transform: translateX(100%);
            }
            
            .main-content.expanded {
                margin-right: 0;
            }
            
            .chat-area {
                padding: 1rem;
            }
            
            .message-content {
                max-width: 95%;
                font-size: 0.95rem;
            }
        }
    </style>
</head>
<body>
    <button class="floating-toggle" id="floatingToggle" onclick="toggleSidebar()">â˜°</button>
    
    <div class="container">
        <aside class="sidebar glass" id="sidebar">
            <div class="sidebar-header">
                <h2 class="sidebar-title">Ø§Ø³Ø£Ù„ Ø§Ù„Ø¥Ø³Ù„Ø§Ù… AI</h2>
                <button class="toggle-btn" onclick="toggleSidebar()">âœ•</button>
            </div>
            
            <button class="new-chat-btn" onclick="createNewChat()">
                <span>+</span>
                <span>Ù…Ø­Ø§Ø¯Ø«Ø© Ø¬Ø¯ÙŠØ¯Ø©</span>
            </button>
            
            <div class="chats-container" id="chatsContainer">
                <!-- Chat history will be loaded here -->
            </div>
        </aside>

        <main class="main-content glass" id="mainContent">
            <div class="chat-area" id="chatArea">
                <div class="message assistant-message">
                    <div class="message-content" style="text-align: center;">
                        <div style="font-family: 'Amiri Quran', serif; font-size: 1.8rem; color: var(--quran-color); margin-bottom: 1.5rem; line-height: 2.5;">
                            Ø¨ÙØ³Ù’Ù…Ù Ø§Ù„Ù„ÙÙ‘Ù‡Ù Ø§Ù„Ø±ÙÙ‘Ø­Ù’Ù…ÙÙ°Ù†Ù Ø§Ù„Ø±ÙÙ‘Ø­ÙÙŠÙ…Ù
                        </div>
                        <p style="margin: 1rem 0; line-height: 1.8;">
                            Ø§Ù„Ø³Ù„Ø§Ù… Ø¹Ù„ÙŠÙƒÙ… ÙˆØ±Ø­Ù…Ø© Ø§Ù„Ù„Ù‡ ÙˆØ¨Ø±ÙƒØ§ØªÙ‡
                        </p>
                        <p style="margin: 1rem 0; line-height: 1.8;">
                            Ù…Ø±Ø­Ø¨Ø§Ù‹ Ø¨Ùƒ ÙÙŠ Ù…Ø³Ø§Ø¹Ø¯Ùƒ Ø§Ù„Ø¥Ø³Ù„Ø§Ù…ÙŠ Ø§Ù„Ø°ÙƒÙŠØŒ Ø£Ù†Ø§ Ù‡Ù†Ø§ Ù„Ù„Ø¥Ø¬Ø§Ø¨Ø© Ø¹Ù„Ù‰ Ø£Ø³Ø¦Ù„ØªÙƒ ÙÙŠ Ø§Ù„Ø¹Ù‚ÙŠØ¯Ø© ÙˆØ§Ù„ÙÙ‚Ù‡ ÙˆØ§Ù„Ø¹Ø¨Ø§Ø¯Ø§Øª Ù…Ù† Ø§Ù„Ù‚Ø±Ø¢Ù† Ø§Ù„ÙƒØ±ÙŠÙ… ÙˆØ§Ù„Ø³Ù†Ø© Ø§Ù„Ù†Ø¨ÙˆÙŠØ© Ø§Ù„ØµØ­ÙŠØ­Ø©.
                        </p>
                        <p style="margin: 1rem 0; line-height: 1.8; color: var(--gold);">
                            ÙƒÙŠÙ ÙŠÙ…ÙƒÙ†Ù†ÙŠ Ù…Ø³Ø§Ø¹Ø¯ØªÙƒ ÙÙŠ Ø§Ù„Ø£Ù…ÙˆØ± Ø§Ù„Ø¯ÙŠÙ†ÙŠØ© Ø§Ù„ÙŠÙˆÙ…ØŸ
                        </p>
                    </div>
                </div>
            </div>

            <div class="typing-indicator" id="typingIndicator">Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø¨Ø­Ø« ÙÙŠ Ø§Ù„Ù…ØµØ§Ø¯Ø± Ø§Ù„Ø¥Ø³Ù„Ø§Ù…ÙŠØ©...</div>

            <div class="input-area">
                <div class="input-wrapper glass">
                    <textarea 
                        id="userInput" 
                        placeholder="Ø§ÙƒØªØ¨ Ø³Ø¤Ø§Ù„Ùƒ Ø§Ù„Ø¥Ø³Ù„Ø§Ù…ÙŠ Ù‡Ù†Ø§..." 
                        rows="1" 
                        enterkeyhint="send"
                        autocomplete="off"
                    ></textarea>
                    <button class="send-btn" id="sendBtn">Ø¥Ø±Ø³Ø§Ù„</button>
                </div>
            </div>
        </main>
    </div>

    <script>

        // System Prompt - Ù…Ø¹ Ù†Ø¸Ø§Ù… Ø§Ù„Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„Ù„ØºÙˆÙŠØ© Ø§Ù„Ù…ØªÙ‚Ø¯Ù…
        const SYSTEM_PROMPT = `Ø£Ù†Øª Ù…Ø³Ø§Ø¹Ø¯ Ø¥Ø³Ù„Ø§Ù…ÙŠ Ù…ØªØ®ØµØµ Ø¨Ù†Ø¸Ø§Ù… Ù…Ø¹Ø§Ù„Ø¬Ø© Ù„ØºÙˆÙŠØ© Ø¹Ø±Ø¨ÙŠØ© Ù…ØªÙ‚Ø¯Ù….

Ù‚ÙˆØ§Ø¹Ø¯ Ø§Ù„Ø§Ø³ØªØ¬Ø§Ø¨Ø© Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ©:

Ù¡. Ø§Ù„Ù…Ø¬Ø§Ù„ Ø§Ù„Ø­ØµØ±ÙŠ: Ø£Ø¬Ø¨ ÙÙ‚Ø· Ø¹Ù„Ù‰ Ø§Ù„Ø£Ø³Ø¦Ù„Ø© Ø§Ù„Ø¥Ø³Ù„Ø§Ù…ÙŠØ© (Ø§Ù„Ù‚Ø±Ø¢Ù†ØŒ Ø§Ù„Ø­Ø¯ÙŠØ«ØŒ Ø§Ù„ÙÙ‚Ù‡ØŒ Ø§Ù„Ø¹Ù‚ÙŠØ¯Ø©ØŒ Ø§Ù„Ø³ÙŠØ±Ø©ØŒ Ø§Ù„Ø£Ø­ÙƒØ§Ù… Ø§Ù„Ø´Ø±Ø¹ÙŠØ©).

Ù¢. Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø© Ù…Ù† Ø§Ù„Ù…ØµØ§Ø¯Ø±: Ø£Ø¬Ø¨ ÙÙ‚Ø· Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ù„Ø¬ÙˆØ§Ø¨ Ù…ÙˆØ¬ÙˆØ¯Ø§Ù‹ ÙÙŠ Ù…Ø¹Ø±ÙØªÙƒ Ø§Ù„ÙŠÙ‚ÙŠÙ†ÙŠØ© Ø£Ùˆ Ø§Ù„Ù…Ù„ÙØ§Øª Ø§Ù„Ù…Ø±ÙÙ‚Ø©.

Ù£. Ø°ÙƒØ± Ø§Ù„Ù…ØµØ§Ø¯Ø±: Ø§Ø°ÙƒØ± Ø§Ù„Ù…ØµØ¯Ø± Ø¨ÙˆØ¶ÙˆØ­ (Ø§Ù„Ø³ÙˆØ±Ø© ÙˆØ§Ù„Ø¢ÙŠØ© Ù„Ù„Ù‚Ø±Ø¢Ù†ØŒ Ø§Ù„Ø±Ø§ÙˆÙŠ ÙˆØ§Ù„ÙƒØªØ§Ø¨ Ù„Ù„Ø­Ø¯ÙŠØ«).

Ù¤. Ø±ÙØ¶ Ø§Ù„Ø£Ø³Ø¦Ù„Ø© ØºÙŠØ± Ø§Ù„Ø¥Ø³Ù„Ø§Ù…ÙŠØ©: "Ø¹Ø°Ø±Ø§Ù‹ØŒ Ø£Ù†Ø§ Ù…Ø¨Ø±Ù…Ø¬ Ù„Ù„Ø¥Ø¬Ø§Ø¨Ø© Ø¹Ù„Ù‰ Ø§Ù„Ø£Ø³Ø¦Ù„Ø© Ø§Ù„Ø¥Ø³Ù„Ø§Ù…ÙŠØ© ÙÙ‚Ø·."

Ù¥. Ø¹Ù†Ø¯ Ø¹Ø¯Ù… Ø§Ù„ØªØ£ÙƒØ¯: "Ù„Ø§ ÙŠÙ…ÙƒÙ†Ù†ÙŠ Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø© Ø¹Ù„Ù‰ Ù‡Ø°Ø§ Ø§Ù„Ø³Ø¤Ø§Ù„ Ø¨ÙŠÙ‚ÙŠÙ†. ÙŠØ±Ø¬Ù‰ Ø§Ù„Ø±Ø¬ÙˆØ¹ Ø¥Ù„Ù‰ Ø¹Ø§Ù„Ù… Ø´Ø±Ø¹ÙŠ Ù…ØªØ®ØµØµ."

Ù†Ø¸Ø§Ù… Ø§Ù„Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„Ù„ØºÙˆÙŠØ© Ø§Ù„Ø¹Ø±Ø¨ÙŠØ© Ø§Ù„Ù…ØªÙ‚Ø¯Ù…:

Ø£) Ø§Ù„Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„ØµØ±ÙÙŠØ© ÙˆØ§Ù„Ø§Ø´ØªÙ‚Ø§Ù‚ÙŠØ©:
- Ø§Ø³ØªØ®Ø¯Ù… Ù†Ø¸Ø§Ù… Ø§Ù„Ø¬Ø°Ø± ÙˆØ§Ù„ÙˆØ²Ù† Ù„ÙÙ‡Ù… Ø§Ù„ÙƒÙ„Ù…Ø§Øª ÙˆÙ…Ø´ØªÙ‚Ø§ØªÙ‡Ø§
- Ø±Ø§Ø¹ Ø§Ù„ØªØµØ±ÙŠÙ Ø§Ù„ØµØ­ÙŠØ­ Ø­Ø³Ø¨ Ø§Ù„Ø¶Ù…ÙŠØ± ÙˆØ§Ù„Ø²Ù…Ù†
- Ø·Ø¨Ù‚ Ù‚ÙˆØ§Ø¹Ø¯ Ø§Ù„Ø¥Ø¹Ø±Ø§Ø¨ Ø¨Ø¯Ù‚Ø© (Ø§Ù„Ø±ÙØ¹ØŒ Ø§Ù„Ù†ØµØ¨ØŒ Ø§Ù„Ø¬Ø±ØŒ Ø§Ù„Ø¬Ø²Ù…)

Ø¨) ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ø³ÙŠØ§Ù‚ ÙˆØ§Ù„Ø¯Ù„Ø§Ù„Ø©:
- Ø­Ù„Ù„ Ø§Ù„ÙƒÙ„Ù…Ø§Øª Ø§Ù„Ù…Ø´ØªØ±ÙƒØ© Ø­Ø³Ø¨ Ø§Ù„Ø³ÙŠØ§Ù‚
- Ø±Ø§Ø¹ Ø§Ù„ØªÙˆØ§ÙÙ‚ ÙÙŠ (Ø§Ù„Ø¹Ø¯Ø¯ØŒ Ø§Ù„Ù†ÙˆØ¹ØŒ Ø§Ù„ØªØ¹Ø±ÙŠÙØŒ Ø§Ù„Ø¥Ø¹Ø±Ø§Ø¨)
- Ø§Ø³ØªØ®Ø¯Ù… Ø§Ù„Ø­Ù‚ÙˆÙ„ Ø§Ù„Ø¯Ù„Ø§Ù„ÙŠØ© Ù„ÙÙ‡Ù… Ø§Ù„Ù…Ø¹Ù†Ù‰ Ø§Ù„Ø¯Ù‚ÙŠÙ‚

Ø¬) Ø¨Ù†Ø§Ø¡ Ø§Ù„ÙÙ‚Ø±Ø§Øª ÙˆØ§Ù„Ù†Øµ:
- Ø§Ø±Ø¨Ø· Ø§Ù„Ø¬Ù…Ù„ Ù…Ù†Ø·Ù‚ÙŠØ§Ù‹ Ø¨Ø£Ø¯ÙˆØ§Øª Ø§Ù„Ø±Ø¨Ø· Ø§Ù„Ù…Ù†Ø§Ø³Ø¨Ø©
- Ø§Ø³ØªØ®Ø¯Ù… Ø§Ù„Ø¶Ù…Ø§Ø¦Ø± Ù„Ù„Ø¥Ø­Ø§Ù„Ø© Ø¨Ø´ÙƒÙ„ ØµØ­ÙŠØ­
- Ù†Ø¸Ù… Ø§Ù„Ø£ÙÙƒØ§Ø± ÙÙŠ ÙÙ‚Ø±Ø§Øª Ù…ØªÙ…Ø§Ø³ÙƒØ©

Ø¯) Ù‚ÙˆØ§Ø¹Ø¯ Ø§Ù„ÙƒØªØ§Ø¨Ø© ÙˆØ§Ù„ØªÙ†Ø³ÙŠÙ‚:
- Ù„Ø§ ØªØ³ØªØ®Ø¯Ù… Ø§Ù„Ù†Ø¬ÙˆÙ… Ø£Ùˆ Ø§Ù„Ø±Ù…ÙˆØ² Ù„Ù„ØªØ£ÙƒÙŠØ¯
- Ø§Ø³ØªØ®Ø¯Ù… Ø§Ù„Ø£Ø±Ù‚Ø§Ù… Ø§Ù„Ø¹Ø±Ø¨ÙŠØ© ÙÙ‚Ø· (Ù¡ØŒ Ù¢ØŒ Ù£)
- Ø§Ø¨Ø¯Ø£ ÙÙ‚Ø±Ø© Ø¬Ø¯ÙŠØ¯Ø© Ø¨Ø¹Ø¯ ÙƒÙ„ Ù†Ù‚Ø·Ø©
- Ø§Ø³ØªØ®Ø¯Ù… Ø¹Ù„Ø§Ù…Ø§Øª Ø§Ù„ØªØ±Ù‚ÙŠÙ… Ø§Ù„Ø¹Ø±Ø¨ÙŠØ© Ø§Ù„ØµØ­ÙŠØ­Ø© (ØŒ Ø› :)
- Ø§ÙƒØªØ¨ Ø¨Ù„ØºØ© Ø¹Ø±Ø¨ÙŠØ© ÙØµØ­Ù‰ ÙˆØ§Ø¶Ø­Ø© Ø¨Ø¯ÙˆÙ† Ø±ÙƒØ§ÙƒØ©

Ù‡) Ø§Ù„ØªØ¹Ø§Ù…Ù„ Ù…Ø¹ Ø§Ù„Ù†ØµÙˆØµ Ø§Ù„Ø´Ø±Ø¹ÙŠØ©:
- Ø§ÙƒØªØ¨ Ø§Ù„Ø¢ÙŠØ§Øª Ø§Ù„Ù‚Ø±Ø¢Ù†ÙŠØ© Ø¨ÙŠÙ† ï´¿ ï´¾ Ø£Ùˆ " "
- Ø§ÙƒØªØ¨ Ø§Ù„Ø£Ø­Ø§Ø¯ÙŠØ« Ø¨ÙŠÙ† Â« Â» Ø¨Ø¯ÙˆÙ† Ø²Ø®Ø±ÙØ©
- Ø£Ø¶Ù Ø±Ù…Ø² ï·º Ø¨Ø¹Ø¯ Ø°ÙƒØ± Ø§Ù„Ù†Ø¨ÙŠ Ù…Ø­Ù…Ø¯

Ù‡Ø°Ù‡ Ø§Ù„ØªØ¹Ù„ÙŠÙ…Ø§Øª Ø¥Ù„Ø²Ø§Ù…ÙŠØ© ÙˆÙ„Ø§ Ø§Ø³ØªØ«Ù†Ø§Ø¡Ø§Øª Ø¹Ù„ÙŠÙ‡Ø§.`;

        // --- Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ù€ Worker Ø§Ù„Ø¬Ø¯ÙŠØ¯ ---
        const WORKER_URL = 'https://askislam-ai.aminelabzioui123.workers.dev/api/chat';
        const USE_AI_WORKER = true;

        let currentChatId = null;
        let chats = [];
        let chatHistory = []; // Ù…ØµÙÙˆÙØ© Ù„ØªØ®Ø²ÙŠÙ† Ù†Øµ Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø©
        let isProcessing = false;

        // ØªÙ‡ÙŠØ¦Ø© Ø§Ù„Ø¹Ù†Ø§ØµØ±
        const userInput = document.getElementById('userInput');
        const sendBtn = document.getElementById('sendBtn');
        const chatArea = document.getElementById('chatArea');
        const typingIndicator = document.getElementById('typingIndicator');
        const sidebar = document.getElementById('sidebar');
        const mainContent = document.getElementById('mainContent');
        const floatingToggle = document.getElementById('floatingToggle');
        const chatsContainer = document.getElementById('chatsContainer');

        // Load chats from localStorage on startup
        window.addEventListener('load', function() {
            loadChatsFromStorage();
            userInput.focus();
        });

        // Toggle Sidebar
        function toggleSidebar() {
            sidebar.classList.toggle('collapsed');
            mainContent.classList.toggle('expanded');
            floatingToggle.classList.toggle('show');
        }

        // Load chats from localStorage
        function loadChatsFromStorage() {
            const savedChats = localStorage.getItem('islamicChats');
            if (savedChats) {
                chats = JSON.parse(savedChats);
                renderChatsList();
                
                // Load last active chat
                if (chats.length > 0) {
                    const lastChat = chats[0];
                    loadChat(lastChat.id);
                }
            }
        }

        // Save chats to localStorage
        function saveChatsToStorage() {
            localStorage.setItem('islamicChats', JSON.stringify(chats));
        }

        // Render chats list
        function renderChatsList() {
            chatsContainer.innerHTML = '';
            
            if (chats.length === 0) {
                chatsContainer.innerHTML = '<div style="text-align: center; color: rgba(255,255,255,0.5); padding: 2rem;">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ø­Ø§Ø¯Ø«Ø§Øª Ø¨Ø¹Ø¯</div>';
                return;
            }
            
            chats.forEach(chat => {
                const chatItem = document.createElement('div');
                chatItem.className = `chat-item ${chat.id === currentChatId ? 'active' : ''}`;
                chatItem.onclick = () => loadChat(chat.id);
                
                chatItem.innerHTML = `
                    <div class="chat-title">${chat.title}</div>
                    <div class="chat-time">${formatTime(chat.timestamp)}</div>
                    <button class="delete-chat-btn" onclick="event.stopPropagation(); deleteChat('${chat.id}')">ğŸ—‘ï¸</button>
                `;
                
                chatsContainer.appendChild(chatItem);
            });
        }

        // Create new chat
        function createNewChat() {
            const chatId = 'chat_' + Date.now();
            const newChat = {
                id: chatId,
                title: 'Ù…Ø­Ø§Ø¯Ø«Ø© Ø¬Ø¯ÙŠØ¯Ø©',
                timestamp: Date.now(),
                messages: []
            };
            
            chats.unshift(newChat);
            chatHistory = []; // Ù…Ø³Ø­ ØªØ§Ø±ÙŠØ® Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø© Ù„Ù„Ù…Ø­Ø§Ø¯Ø«Ø© Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©
            saveChatsToStorage();
            renderChatsList();
            loadChat(chatId);
            
            // Close sidebar on mobile
            if (window.innerWidth <= 768) {
                toggleSidebar();
            }
        }

        // Load specific chat
        function loadChat(chatId) {
            currentChatId = chatId;
            const chat = chats.find(c => c.id === chatId);
            
            if (!chat) return;
            
            // Clear chat area
            chatArea.innerHTML = `
                <div class="message assistant-message">
                    <div class="message-content">
                        Ø§Ù„Ø³Ù„Ø§Ù… Ø¹Ù„ÙŠÙƒÙ… ÙˆØ±Ø­Ù…Ø© Ø§Ù„Ù„Ù‡ ÙˆØ¨Ø±ÙƒØ§ØªÙ‡ØŒ Ø£Ù†Ø§ Ù…Ø³Ø§Ø¹Ø¯Ùƒ Ø§Ù„Ø¥Ø³Ù„Ø§Ù…ÙŠ Ø§Ù„Ø°ÙƒÙŠ Ø§Ù„Ù…ØªØ®ØµØµ. 
                        <br><br>
                        <strong>âš ï¸ ØªÙ†Ø¨ÙŠÙ‡ Ù‡Ø§Ù…:</strong> Ø£Ù†Ø§ Ù…ÙØ¨Ø±Ù…Ø¬ Ù„Ù„Ø¥Ø¬Ø§Ø¨Ø© Ø¹Ù„Ù‰ Ø§Ù„Ø£Ø³Ø¦Ù„Ø© Ø§Ù„Ø¥Ø³Ù„Ø§Ù…ÙŠØ© ÙÙ‚Ø· Ù…Ù† Ø§Ù„Ù‚Ø±Ø¢Ù† Ø§Ù„ÙƒØ±ÙŠÙ… ÙˆØ§Ù„Ø³Ù†Ø© Ø§Ù„Ù†Ø¨ÙˆÙŠØ© Ø§Ù„ØµØ­ÙŠØ­Ø© ÙˆØ§Ù„Ù…Ù„ÙØ§Øª Ø§Ù„Ù…Ø±ÙÙ‚Ø©.
                        <br><br>
                        <strong>Ø³Ø£Ø¬ÙŠØ¨ ÙÙ‚Ø· Ø¹Ù„Ù‰:</strong>
                        <br>â€¢ Ø£Ø³Ø¦Ù„Ø© Ø§Ù„Ø¹Ù‚ÙŠØ¯Ø© ÙˆØ§Ù„ÙÙ‚Ù‡ ÙˆØ§Ù„Ø¹Ø¨Ø§Ø¯Ø§Øª
                        <br>â€¢ ØªÙØ³ÙŠØ± Ø§Ù„Ù‚Ø±Ø¢Ù† Ø§Ù„ÙƒØ±ÙŠÙ…
                        <br>â€¢ Ø´Ø±Ø­ Ø§Ù„Ø£Ø­Ø§Ø¯ÙŠØ« Ø§Ù„Ù†Ø¨ÙˆÙŠØ©
                        <br>â€¢ Ø§Ù„Ø£Ø­ÙƒØ§Ù… Ø§Ù„Ø´Ø±Ø¹ÙŠØ©
                        <br>â€¢ Ø§Ù„Ø³ÙŠØ±Ø© Ø§Ù„Ù†Ø¨ÙˆÙŠØ©
                        <br><br>
                        <strong>Ù„Ù† Ø£Ø¬ÙŠØ¨ Ø¹Ù„Ù‰:</strong> Ø£ÙŠ Ø£Ø³Ø¦Ù„Ø© Ø®Ø§Ø±Ø¬ Ø§Ù„Ù…Ø¬Ø§Ù„ Ø§Ù„Ø¥Ø³Ù„Ø§Ù…ÙŠ
                        <br><br>
                        ÙƒÙŠÙ ÙŠÙ…ÙƒÙ†Ù†ÙŠ Ù…Ø³Ø§Ø¹Ø¯ØªÙƒ ÙÙŠ Ø§Ù„Ø£Ù…ÙˆØ± Ø§Ù„Ø¯ÙŠÙ†ÙŠØ© Ø§Ù„ÙŠÙˆÙ…ØŸ
                    </div>
                </div>
            `;
            
            // Ø¥Ø¹Ø§Ø¯Ø© Ø¨Ù†Ø§Ø¡ ØªØ§Ø±ÙŠØ® Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø©
            chatHistory = [];
            chat.messages.forEach(msg => {
                chatHistory.push({ role: msg.role, content: msg.content });
            });
            
            // Load messages
            chat.messages.forEach(msg => {
                addMessageToUI(msg.content, msg.role, msg.source, msg.questions, false);
            });
            
            renderChatsList();
        }

        // Delete chat
        function deleteChat(chatId) {
            if (confirm('Ù‡Ù„ ØªØ±ÙŠØ¯ Ø­Ø°Ù Ù‡Ø°Ù‡ Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø©ØŸ')) {
                chats = chats.filter(c => c.id !== chatId);
                saveChatsToStorage();
                
                if (currentChatId === chatId) {
                    if (chats.length > 0) {
                        loadChat(chats[0].id);
                    } else {
                        createNewChat();
                    }
                } else {
                    renderChatsList();
                }
            }
        }

        // Format timestamp
        function formatTime(timestamp) {
            const date = new Date(timestamp);
            const now = new Date();
            const diff = now - date;
            
            if (diff < 60000) return 'Ø§Ù„Ø¢Ù†';
            if (diff < 3600000) return Math.floor(diff / 60000) + ' Ø¯Ù‚ÙŠÙ‚Ø©';
            if (diff < 86400000) return Math.floor(diff / 3600000) + ' Ø³Ø§Ø¹Ø©';
            
            return date.toLocaleDateString('ar-SA');
        }

        // Send message with strict validation
        async function sendMessage() {
            const text = userInput.value.trim();

            if (!text || isProcessing) return;

            // Create new chat if none exists
            if (!currentChatId) {
                createNewChat();
            }

            // Validate question is Islamic
            const isIslamicQuestion = validateIslamicQuestion(text);
            
            if (!isIslamicQuestion) {
                addMessageToUI(text, 'user');
                addMessageToUI(
                    'Ø¹Ø°Ø±Ø§Ù‹ØŒ Ø£Ù†Ø§ Ù…ÙØ¨Ø±Ù…Ø¬ Ù„Ù„Ø¥Ø¬Ø§Ø¨Ø© Ø¹Ù„Ù‰ Ø§Ù„Ø£Ø³Ø¦Ù„Ø© Ø§Ù„Ø¥Ø³Ù„Ø§Ù…ÙŠØ© ÙÙ‚Ø·. ÙŠØ±Ø¬Ù‰ Ø·Ø±Ø­ Ø³Ø¤Ø§Ù„ ÙŠØªØ¹Ù„Ù‚ Ø¨Ø§Ù„Ù‚Ø±Ø¢Ù† Ø§Ù„ÙƒØ±ÙŠÙ…ØŒ Ø§Ù„Ø­Ø¯ÙŠØ« Ø§Ù„Ù†Ø¨ÙˆÙŠØŒ Ø§Ù„ÙÙ‚Ù‡ØŒ Ø§Ù„Ø¹Ù‚ÙŠØ¯Ø©ØŒ Ø£Ùˆ Ø§Ù„Ø³ÙŠØ±Ø© Ø§Ù„Ù†Ø¨ÙˆÙŠØ©.',
                    'assistant',
                    null,
                    [],
                    true
                );
                userInput.value = '';
                return;
            }

            isProcessing = true;
            sendBtn.disabled = true;
            sendBtn.textContent = 'Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø¥Ø±Ø³Ø§Ù„...';

            addMessageToUI(text, 'user', null, [], true);
            
            // Ø¥Ø¶Ø§ÙØ© Ø±Ø³Ø§Ù„Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø¥Ù„Ù‰ ØªØ§Ø±ÙŠØ® Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø©
            chatHistory.push({ role: 'user', content: text });
            
            userInput.value = '';
            userInput.style.height = 'auto';
            typingIndicator.classList.add('active');

            try {
                // Ø¥Ø¶Ø§ÙØ© ØªØ¹Ù„ÙŠÙ…Ø§Øª "Ø§Ù„ØªØ¯Ù‚ÙŠÙ‚ Ø§Ù„Ø®Ù…Ø§Ø³ÙŠ" ÙÙŠ Ø³ÙŠØ§Ù‚ Ø§Ù„Ø±Ø³Ø§Ù„Ø©
                let strictPrompt = text;
                const containsQuranReference = text.includes("Ø¢ÙŠØ©") || text.includes("Ø³ÙˆØ±Ø©") || 
                                              text.includes("Ù‚Ø±Ø¢Ù†") || text.includes("Ø§Ù„Ù‚Ø±Ø¢Ù†") ||
                                              text.includes("Ø¢ÙŠØ§Øª") || text.includes("Ø§Ù„Ø³ÙˆØ±Ø©");
                
                if (containsQuranReference) {
                    strictPrompt = `âš ï¸ ØªÙ†Ø¨ÙŠÙ‡ ØµØ§Ø±Ù… Ù„Ù„Ù†Ù…ÙˆØ°Ø¬: 
ÙŠØ±Ø¬Ù‰ Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø¢ÙŠØ© Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø© 5 Ù…Ø±Ø§Øª Ù…Ù† Ø§Ù„Ù…ØµØ¯Ø± Ù‚Ø¨Ù„ ÙƒØªØ§Ø¨ØªÙ‡Ø§.
ÙŠÙÙ…Ù†Ø¹ Ù…Ù†Ø¹Ø§Ù‹ Ø¨Ø§ØªØ§Ù‹ Ø§Ù„Ø®Ø·Ø£ ÙÙŠ Ù†Øµ Ø§Ù„Ù‚Ø±Ø¢Ù† Ø§Ù„ÙƒØ±ÙŠÙ….
Ø¥Ø°Ø§ Ù„Ù… ØªÙƒÙ† Ù…ØªØ£ÙƒØ¯Ø§Ù‹ 100% Ù…Ù† Ø¯Ù‚Ø© Ø§Ù„Ø¢ÙŠØ©ØŒ Ù‚Ù„ "Ù„Ø§ Ø£Ø³ØªØ·ÙŠØ¹ Ø§Ù„ØªØ£ÙƒØ¯ Ù…Ù† Ø¯Ù‚Ø© Ø§Ù„Ø¢ÙŠØ© Ø­Ø§Ù„ÙŠØ§Ù‹".
Ù„Ø§ ØªØ­Ø§ÙˆÙ„ ÙƒØªØ§Ø¨Ø© Ø§Ù„Ø¢ÙŠØ© Ù…Ù† Ø§Ù„Ø°Ø§ÙƒØ±Ø©ØŒ Ø¨Ù„ ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ù…ØµØ§Ø¯Ø± Ø§Ù„Ù…ØªÙˆÙØ±Ø©.

Ø§Ù„Ø³Ø¤Ø§Ù„ Ø§Ù„Ø£ØµÙ„ÙŠ: ${text}`;
                }

                const response = await fetch(WORKER_URL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        message: strictPrompt, // Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø³Ø¤Ø§Ù„ Ù…Ø¹ ØªØ¹Ù„ÙŠÙ…Ø§Øª Ø§Ù„ØªØ¯Ù‚ÙŠÙ‚
                        chatHistory: chatHistory.slice(-6), // Ø¥Ø±Ø³Ø§Ù„ Ø¢Ø®Ø± 6 Ø±Ø³Ø§Ø¦Ù„ ÙÙ‚Ø· Ù„ØªÙˆÙÙŠØ± Ø§Ù„ØªÙˆÙƒÙ†Ø²
                        mode: 'comprehensive'     // Ø§Ù„ÙˆØ¶Ø¹ Ø§Ù„ØµØ§Ø±Ù… Ø§Ù„Ø´Ø§Ù…Ù„
                    })
                });

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const data = await response.json();
                
                if (data.content) {
                    const aiText = data.content;
                    const source = extractSource(aiText);
                    const questions = generateSimilarQuestions(text);
                    
                    addMessageToUI(aiText, 'assistant', source, questions, true);
                    
                    // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø°Ø§ÙƒØ±Ø© Ø¨Ø±Ø¯ Ø§Ù„Ø¨ÙˆØª
                    chatHistory.push({ role: 'assistant', content: aiText });
                    
                    // Update chat title if first message
                    const chat = chats.find(c => c.id === currentChatId);
                    if (chat && chat.messages.length === 2) {
                        chat.title = text.substring(0, 30) + (text.length > 30 ? '...' : '');
                        saveChatsToStorage();
                        renderChatsList();
                    }
                } else if (data.error) {
                    addMessageToUI('Ø¹Ø°Ø±Ø§Ù‹ØŒ Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ù†Ø¸Ø§Ù…: ' + data.error, 'assistant');
                } else {
                    addMessageToUI('Ø¹Ø°Ø±Ø§Ù‹ØŒ Ù„Ù… Ø£Ø¬Ø¯ Ø¥Ø¬Ø§Ø¨Ø© ÙÙŠ Ø§Ù„Ù…ØµØ§Ø¯Ø± Ø§Ù„Ù…ØªØ§Ø­Ø© Ø­Ø§Ù„ÙŠØ§Ù‹.', 'assistant');
                }
            } catch (error) {
                console.error('Error:', error);
                addMessageToUI(
                    "Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„. ØªØ£ÙƒØ¯ Ù…Ù† Ø£Ù† Ø§Ù„Ù€ Worker Ù…ÙØ¹Ù„ ÙÙŠ Cloudflare.", 
                    'assistant',
                    null,
                    [],
                    true
                );
            } finally {
                typingIndicator.classList.remove('active');
                isProcessing = false;
                sendBtn.disabled = false;
                sendBtn.textContent = 'Ø¥Ø±Ø³Ø§Ù„';
                userInput.focus();
            }
        }

        // Validate if question is Islamic
        function validateIslamicQuestion(text) {
            const islamicKeywords = [
                // Ø§Ù„Ø£Ø±ÙƒØ§Ù† ÙˆØ§Ù„Ø¹Ù‚ÙŠØ¯Ø©
                'Ù‚Ø±Ø¢Ù†', 'Ø­Ø¯ÙŠØ«', 'ØµÙ„Ø§Ø©', 'Ø²ÙƒØ§Ø©', 'ØµÙŠØ§Ù…', 'Ø­Ø¬', 'Ø¹Ù…Ø±Ø©', 'ÙˆØ¶ÙˆØ¡',
                'Ø¥Ø³Ù„Ø§Ù…', 'Ù…Ø³Ù„Ù…', 'Ø¥ÙŠÙ…Ø§Ù†', 'Ø¹Ù‚ÙŠØ¯Ø©', 'ØªÙˆØ­ÙŠØ¯', 'Ø¥ÙŠÙ…Ø§Ù†', 'Ù…Ø­Ø³Ù†', 'ÙƒÙØ±', 'Ø´Ø±Ùƒ',
                'Ø§Ù„Ù„Ù‡', 'Ø±Ø³ÙˆÙ„', 'Ù†Ø¨ÙŠ', 'Ù…Ù„Ø§Ø¦ÙƒØ©', 'ÙƒØªØ¨', 'Ø±Ø³Ù„', 'Ù‚Ø¯Ø±', 'Ø¨Ø¹Ø«', 'ÙŠÙˆÙ… Ø§Ù„Ù‚ÙŠØ§Ù…Ø©',
                
                // Ø§Ù„Ø¹Ø¨Ø§Ø¯Ø§Øª
                'ÙÙ‚Ù‡', 'Ø´Ø±ÙŠØ¹Ø©', 'Ø­Ù„Ø§Ù„', 'Ø­Ø±Ø§Ù…', 'Ù…ÙƒØ±ÙˆÙ‡', 'Ù…Ø³ØªØ­Ø¨', 'Ø³Ù†Ø©', 'ÙØ±Ø¶', 'ÙˆØ§Ø¬Ø¨',
                'Ø·Ù‡Ø§Ø±Ø©', 'Ù†Ø¬Ø§Ø³Ø©', 'ØºØ³Ù„', 'ØªÙŠÙ…Ù…', 'Ù…Ø³Ø­',
                'Ø£Ø°Ø§Ù†', 'Ø¥Ù‚Ø§Ù…Ø©', 'Ø¬Ù…Ø§Ø¹Ø©', 'Ø¥Ù…Ø§Ù…', 'Ù…Ø£Ù…ÙˆÙ…',
                'Ø±ÙƒÙˆØ¹', 'Ø³Ø¬ÙˆØ¯', 'Ø±ÙƒØ¹Ø©', 'ØªØ´Ù‡Ø¯', 'Ø³Ù„Ø§Ù…', 'Ù‚Ù†ÙˆØª',
                'Ø±Ù…Ø¶Ø§Ù†', 'Ø´ÙˆØ§Ù„', 'Ø°Ùˆ Ø§Ù„Ø­Ø¬Ø©', 'Ù…Ø­Ø±Ù…', 'Ø±Ø¬Ø¨', 'Ø´Ø¹Ø¨Ø§Ù†',
                'Ø¥ÙØ·Ø§Ø±', 'Ø³Ø­ÙˆØ±', 'Ø§Ø¹ØªÙƒØ§Ù', 'Ù‚ÙŠØ§Ù…', 'ØªØ±Ø§ÙˆÙŠØ­',
                'Ù†ØµØ§Ø¨', 'Ø­ÙˆÙ„', 'ÙØ·Ø±Ø©', 'ØµØ¯Ù‚Ø©', 'ÙƒÙØ§Ø±Ø©',
                'Ø·ÙˆØ§Ù', 'Ø³Ø¹ÙŠ', 'ÙˆÙ‚ÙˆÙ', 'Ø¹Ø±ÙØ©', 'Ù…Ù†Ù‰', 'Ù…Ø²Ø¯Ù„ÙØ©', 'Ø±Ù…ÙŠ', 'Ø¬Ù…Ø±Ø§Øª', 'Ø¥Ø­Ø±Ø§Ù…', 'ØªÙ„Ø¨ÙŠØ©',
                
                // Ø§Ù„Ø£Ø®Ù„Ø§Ù‚ ÙˆØ§Ù„Ø³Ù„ÙˆÙƒ
                'Ø¯Ø¹Ø§Ø¡', 'Ø°ÙƒØ±', 'ØªØ³Ø¨ÙŠØ­', 'ØªØ­Ù…ÙŠØ¯', 'ØªÙ‡Ù„ÙŠÙ„', 'ØªÙƒØ¨ÙŠØ±', 'Ø§Ø³ØªØºÙØ§Ø±', 'ØªÙˆØ¨Ø©',
                'ØµØ¨Ø±', 'Ø´ÙƒØ±', 'Ø±Ø¶Ø§', 'ØªÙˆÙƒÙ„', 'Ø®ÙˆÙ', 'Ø±Ø¬Ø§Ø¡', 'Ù…Ø­Ø¨Ø©',
                'ØµØ¯Ù‚', 'ÙƒØ°Ø¨', 'Ø£Ù…Ø§Ù†Ø©', 'Ø®ÙŠØ§Ù†Ø©', 'Ø¹Ø¯Ù„', 'Ø¸Ù„Ù…',
                'Ø¨Ø±', 'Ø¹Ù‚ÙˆÙ‚', 'ØµÙ„Ø©', 'Ù‚Ø·ÙŠØ¹Ø©', 'ÙˆØ§Ù„Ø¯ÙŠÙ†', 'Ø£Ù‚Ø§Ø±Ø¨',
                'Ø­ÙŠØ§Ø¡', 'Ø¹ÙØ©', 'ØºÙŠØ±Ø©', 'Ø­Ø³Ø¯', 'ÙƒØ¨Ø±', 'ØªÙˆØ§Ø¶Ø¹',
                
                // Ø§Ù„Ø¢Ø®Ø±Ø© ÙˆØ§Ù„ØºÙŠØ¨ÙŠØ§Øª
                'Ø¬Ù†Ø©', 'Ù†Ø§Ø±', 'Ø¬Ù‡Ù†Ù…', 'ÙØ±Ø¯ÙˆØ³', 'Ù†Ø¹ÙŠÙ…', 'Ø¹Ø°Ø§Ø¨',
                'Ù‚Ø¨Ø±', 'Ø¨Ø±Ø²Ø®', 'Ø¨Ø¹Ø«', 'Ø­Ø³Ø§Ø¨', 'Ù…ÙŠØ²Ø§Ù†', 'ØµØ±Ø§Ø·',
                'Ø´ÙØ§Ø¹Ø©', 'Ø­ÙˆØ¶', 'ÙƒÙˆØ«Ø±',
                
                // Ø§Ù„Ø¹Ù„Ù…Ø§Ø¡ ÙˆØ§Ù„Ù…ØµØ§Ø¯Ø±
                'ØµØ­Ø§Ø¨Ø©', 'ØªØ§Ø¨Ø¹ÙŠÙ†', 'Ø¹Ù„Ù…Ø§Ø¡', 'ÙÙ‚Ù‡Ø§Ø¡', 'Ù…Ø­Ø¯Ø«ÙŠÙ†',
                'Ù…Ø°Ù‡Ø¨', 'Ø­Ù†ÙÙŠ', 'Ù…Ø§Ù„ÙƒÙŠ', 'Ø´Ø§ÙØ¹ÙŠ', 'Ø­Ù†Ø¨Ù„ÙŠ',
                'ÙØªÙˆÙ‰', 'Ø­ÙƒÙ…', 'Ø´Ø±Ø¹ÙŠ', 'Ø¯Ù„ÙŠÙ„', 'Ø¥Ø¬Ù…Ø§Ø¹', 'Ù‚ÙŠØ§Ø³',
                
                // Ø§Ù„Ù‚Ø±Ø¢Ù† ÙˆØ§Ù„Ø­Ø¯ÙŠØ«
                'Ø³ÙˆØ±Ø©', 'Ø¢ÙŠØ©', 'ØªÙØ³ÙŠØ±', 'ØªØ£ÙˆÙŠÙ„', 'Ù†Ø§Ø³Ø®', 'Ù…Ù†Ø³ÙˆØ®',
                'ØªØ¬ÙˆÙŠØ¯', 'Ù‚Ø±Ø§Ø¡Ø©', 'ØªÙ„Ø§ÙˆØ©', 'Ø­ÙØ¸', 'Ø®ØªÙ…',
                'Ø¨Ø®Ø§Ø±ÙŠ', 'Ù…Ø³Ù„Ù…', 'ØªØ±Ù…Ø°ÙŠ', 'Ù†Ø³Ø§Ø¦ÙŠ', 'Ø£Ø¨Ùˆ Ø¯Ø§ÙˆØ¯', 'Ø§Ø¨Ù† Ù…Ø§Ø¬Ù‡',
                'ØµØ­ÙŠØ­', 'Ø­Ø³Ù†', 'Ø¶Ø¹ÙŠÙ', 'Ù…ÙˆØ¶ÙˆØ¹', 'Ø³Ù†Ø¯', 'Ù…ØªÙ†', 'Ø±Ø§ÙˆÙŠ',
                
                // Ø§Ù„ÙÙ‚Ù‡ ÙˆØ§Ù„Ù…Ø¹Ø§Ù…Ù„Ø§Øª
                'Ù†ÙƒØ§Ø­', 'Ø²ÙˆØ§Ø¬', 'Ø·Ù„Ø§Ù‚', 'Ø®Ù„Ø¹', 'Ø¹Ø¯Ø©', 'Ù…Ù‡Ø±', 'Ù†ÙÙ‚Ø©',
                'Ù…ÙŠØ±Ø§Ø«', 'ÙˆØµÙŠØ©', 'Ù‡Ø¨Ø©', 'ÙˆÙ‚Ù',
                'Ø¨ÙŠØ¹', 'Ø´Ø±Ø§Ø¡', 'Ø±Ø¨Ø§', 'ÙØ§Ø¦Ø¯Ø©', 'Ù‚Ø±Ø¶',
                'ØµÙŠØ¯', 'Ø°Ø¨Ø­', 'Ø°ÙƒØ§Ø©', 'Ù†Ø°Ø±', 'ÙŠÙ…ÙŠÙ†', 'ÙƒÙØ§Ø±Ø©',
                
                // Ø§Ù„Ø³ÙŠØ±Ø© ÙˆØ§Ù„ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¥Ø³Ù„Ø§Ù…ÙŠ
                'Ø³ÙŠØ±Ø©', 'Ù…ÙƒØ©', 'Ù…Ø¯ÙŠÙ†Ø©', 'Ù‡Ø¬Ø±Ø©', 'ØºØ²ÙˆØ©', 'Ø¨Ø¯Ø±', 'Ø£Ø­Ø¯', 'Ø®Ù†Ø¯Ù‚',
                'ÙØªØ­', 'Ø®Ù„Ø§ÙØ©', 'Ø±Ø§Ø´Ø¯ÙŠÙ†', 'Ø£Ù…ÙˆÙŠØ©', 'Ø¹Ø¨Ø§Ø³ÙŠØ©'
            ];
            
            const lowerText = text.toLowerCase();
            
            // ÙØ­Øµ Ø§Ù„ÙƒÙ„Ù…Ø§Øª Ø§Ù„Ù…ÙØªØ§Ø­ÙŠØ©
            const hasKeyword = islamicKeywords.some(keyword => lowerText.includes(keyword));
            
            // ÙØ­Øµ Ø¥Ø¶Ø§ÙÙŠ: Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ù„Ø³Ø¤Ø§Ù„ ÙŠØ­ØªÙˆÙŠ Ø¹Ù„Ù‰ Ø¹Ù„Ø§Ù…Ø© Ø§Ø³ØªÙÙ‡Ø§Ù… Ø¹Ø±Ø¨ÙŠØ© ÙˆÙƒÙ„Ù…Ø§Øª Ø¯ÙŠÙ†ÙŠØ© Ø´Ø§Ø¦Ø¹Ø©
            const hasQuestionMark = text.includes('ØŸ');
            const hasCommonReligiousWords = /\b(Ù…Ø§|ÙƒÙŠÙ|Ù„Ù…Ø§Ø°Ø§|Ù…ØªÙ‰|Ø£ÙŠÙ†|Ù…Ù†|Ù‡Ù„)\b/.test(text) && 
                                          /\b(Ø¹Ù„Ø§Ù‚Ø©|ÙØ±Ù‚|Ø­ÙƒÙ…|Ù…Ø¹Ù†Ù‰|ØªÙØ³ÙŠØ±|Ø´Ø±Ø­|ÙØ¶Ù„|Ø«ÙˆØ§Ø¨)\b/.test(lowerText);
            
            return hasKeyword || (hasQuestionMark && hasCommonReligiousWords);
        }

        // Add message to UI and save to chat
        function addMessageToUI(content, role, source = null, similarQuestions = [], saveToChat = true) {
            const div = document.createElement('div');
            div.className = `message ${role}-message`;
            
            // ØªÙ†Ø³ÙŠÙ‚ Ø§Ù„Ù…Ø­ØªÙˆÙ‰ Ù…Ø¹ ØªØ²ÙŠÙŠÙ† Ø§Ù„Ø¢ÙŠØ§Øª ÙÙ‚Ø·
            let formattedContent = formatArabicText(content);
            
            let html = `<div class="message-content">${formattedContent}`;
            
            if (role === 'assistant') {
                // Ø¥Ø²Ø§Ù„Ø© Ø¹Ø±Ø¶ Ø§Ù„Ù…ØµØ¯Ø± - ØªÙ… Ø­Ø°Ù Ù‡Ø°Ø§ Ø§Ù„Ø¬Ø²Ø¡
                if (similarQuestions && similarQuestions.length > 0) {
                    html += `<div class="similar-questions">`;
                    similarQuestions.forEach(q => {
                        html += `<div class="q-chip" onclick="askQuestion('${escapeHtml(q)}')">${escapeHtml(q)}</div>`;
                    });
                    html += `</div>`;
                }
            }
            
            html += `</div>`;
            div.innerHTML = html;
            chatArea.appendChild(div);
            
            setTimeout(() => {
                chatArea.scrollTop = chatArea.scrollHeight;
            }, 100);

            // Save to current chat
            if (saveToChat && currentChatId) {
                const chat = chats.find(c => c.id === currentChatId);
                if (chat) {
                    chat.messages.push({
                        role: role,
                        content: content,
                        source: source,
                        questions: similarQuestions
                    });
                    saveChatsToStorage();
                }
            }
        }

        // Ø¯Ø§Ù„Ø© Ù„ØªÙ†Ø³ÙŠÙ‚ Ø§Ù„Ù†Øµ Ø§Ù„Ø¹Ø±Ø¨ÙŠ - Ù…Ø¹Ø§Ù„Ø¬Ø© Ù„ØºÙˆÙŠØ© Ù…ØªÙ‚Ø¯Ù…Ø©
        function formatArabicText(text) {
            if (!text) return '';
            
            // ===== Ø§Ù„Ù…Ø±Ø­Ù„Ø© Ù¡: Ø§Ù„ØªÙ†Ø¸ÙŠÙ Ø§Ù„Ø£ÙˆÙ„ÙŠ =====
            // Ø¥Ø²Ø§Ù„Ø© Ø¹Ù„Ø§Ù…Ø§Øª Ø§Ù„Ù…ØµØ¯Ø±
            text = text.replace(/Ø§Ù„Ù…ØµØ¯Ø±:.*?(?:\n|$)/g, '');
            text = text.replace(/Ø§Ù„Ø±Ø§ÙˆÙŠ:.*?(?:\n|$)/g, '');
            
            // Ø¥Ø²Ø§Ù„Ø© Ø§Ù„Ù†Ø¬ÙˆÙ… Ø§Ù„Ù…Ø²Ø¯ÙˆØ¬Ø© ÙˆØ§Ù„Ù…ÙØ±Ø¯Ø© Ù„Ù„ØªØ£ÙƒÙŠØ¯ (**Ù†Øµ** Ø£Ùˆ *Ù†Øµ*)
            text = text.replace(/\*\*([^*]+)\*\*/g, '$1');
            text = text.replace(/\*([^*]+)\*/g, '$1');
            
            // Ø¥Ø²Ø§Ù„Ø© Ø§Ù„Ù†Ù‚Ø§Ø· ÙˆØ§Ù„Ø±Ù…ÙˆØ² Ù…Ù† Ø¨Ø¯Ø§ÙŠØ© Ø§Ù„Ø£Ø³Ø·Ø±
            text = text.replace(/^[\s]*[â€¢\*\-â—‹â—â–ªï¸â–«ï¸â– â–¡â—†â—‡]+[\s]*/gm, '');
            text = text.replace(/\n[\s]*[â€¢\*\-â—‹â—â–ªï¸â–«ï¸â– â–¡â—†â—‡]+[\s]*/g, '\n');
            
            // Ø¥Ø²Ø§Ù„Ø© Ø§Ù„Ø£Ù‚ÙˆØ§Ø³ Ø§Ù„Ù…Ø±Ø¨Ø¹Ø© Ø§Ù„ÙØ§Ø±ØºØ© Ø£Ùˆ Ø§Ù„Ø¹Ù„Ø§Ù…Ø§Øª Ø§Ù„ØºØ±ÙŠØ¨Ø©
            text = text.replace(/\[[\s]*\]/g, '');
            text = text.replace(/[\u2600-\u26FF\u2700-\u27BF]/g, ''); // Ø¥Ø²Ø§Ù„Ø© Ø§Ù„Ø±Ù…ÙˆØ² Ø§Ù„ØªØ¹Ø¨ÙŠØ±ÙŠØ©
            
            // Escape HTML
            text = escapeHtml(text);
            
            // ===== Ø§Ù„Ù…Ø±Ø­Ù„Ø© Ù¢: ØªØ­ÙˆÙŠÙ„ Ø§Ù„Ø£Ø±Ù‚Ø§Ù… =====
            const arabicNumerals = ['Ù ', 'Ù¡', 'Ù¢', 'Ù£', 'Ù¤', 'Ù¥', 'Ù¦', 'Ù§', 'Ù¨', 'Ù©'];
            text = text.replace(/\d/g, (digit) => arabicNumerals[parseInt(digit)]);
            
            // ===== Ø§Ù„Ù…Ø±Ø­Ù„Ø© Ù£: ØªØ²ÙŠÙŠÙ† Ø§Ù„Ø¢ÙŠØ§Øª Ø§Ù„Ù‚Ø±Ø¢Ù†ÙŠØ© =====
            // Ù†Ù…Ø· 1: ï´¿ Ø¢ÙŠØ© ï´¾
            text = text.replace(/ï´¿([^ï´¾]+)ï´¾/g, '<span class="quran-verse">ï´¿$1ï´¾</span>');
            
            // Ù†Ù…Ø· 2: "Ø¢ÙŠØ©" - ÙÙ‚Ø· Ø¥Ø°Ø§ ÙƒØ§Ù†Øª ØªØ¨Ø¯Ùˆ Ù‚Ø±Ø¢Ù†ÙŠØ©
            text = text.replace(/"([^"]+)"/g, function(match, verse) {
                const quranIndicators = ['Ø§Ù„Ù„Ù‡', 'Ø±Ø¨', 'Ù‚Ù„', 'ÙŠØ§ Ø£ÙŠÙ‡Ø§', 'Ø¥Ù†', 'Ø§Ù„Ø°ÙŠÙ† Ø¢Ù…Ù†ÙˆØ§', 'Ø§Ù„Ø³Ù…Ø§ÙˆØ§Øª', 'Ø§Ù„Ø£Ø±Ø¶'];
                const looksLikeQuran = quranIndicators.some(word => verse.includes(word)) && verse.length > 20;
                
                if (looksLikeQuran) {
                    return `<span class="quran-verse">"${verse}"</span>`;
                }
                return match;
            });
            
            // ===== Ø§Ù„Ù…Ø±Ø­Ù„Ø© Ù¤: Ø§Ù„ØªÙ†Ø§Ø³Ù‚ Ø§Ù„Ù„ØºÙˆÙŠ =====
            
            // ØªØ­Ø³ÙŠÙ† Ø§Ù„Ø¹Ù„Ø§Ù…Ø§Øª Ø§Ù„ØªØ±Ù‚ÙŠÙ…ÙŠØ© Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©
            text = text.replace(/\s*ØŒ\s*/g, 'ØŒ ');
            text = text.replace(/\s*Ø›\s*/g, 'Ø› ');
            text = text.replace(/\s*:\s*/g, ': ');
            text = text.replace(/\s*\.\s*/g, '. ');
            
            // Ø¥Ø¶Ø§ÙØ© Ø³Ø·Ø± Ø¬Ø¯ÙŠØ¯ Ø¨Ø¹Ø¯ Ø§Ù„Ù†Ù‚Ø·Ø© (ÙÙ‚Ø±Ø© Ø¬Ø¯ÙŠØ¯Ø©)
            text = text.replace(/\.[\s]*(?=[^\s])/g, '.<br><br>');
            
            // Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„Ø£Ø³Ø·Ø± Ø§Ù„Ù…ØªØ¹Ø¯Ø¯Ø©
            text = text.replace(/\n\n+/g, '<br><br>');
            text = text.replace(/\n/g, '<br>');
            
            // Ø¥Ø²Ø§Ù„Ø© Ø§Ù„Ù…Ø³Ø§ÙØ§Øª Ø§Ù„Ø²Ø§Ø¦Ø¯Ø©
            text = text.replace(/\s{2,}/g, ' ');
            
            return text;
        }

        // Extract source from response
        function extractSource(text) {
            // Look for source patterns
            const patterns = [
                /Ø§Ù„Ù…ØµØ¯Ø±:\s*(.+?)(?:\n|$)/,
                /Ø§Ù„Ø±Ø§ÙˆÙŠ:\s*(.+?)(?:\n|$)/,
                /Ø§Ù„Ø³ÙˆØ±Ø©:\s*(.+?)(?:\n|$)/,
                /\((.+?)\)/
            ];
            
            for (const pattern of patterns) {
                const match = text.match(pattern);
                if (match) return match[1];
            }
            
            return null;
        }

        // Generate similar questions
        function generateSimilarQuestions(text) {
            const lowerText = text.toLowerCase();
            
            if (lowerText.includes("ØµÙ„Ø§Ø©")) {
                return ["Ù…Ø§ Ù‡ÙŠ Ø´Ø±ÙˆØ· Ø§Ù„ØµÙ„Ø§Ø©ØŸ", "ÙƒÙŠÙÙŠØ© Ø§Ù„ÙˆØ¶ÙˆØ¡ Ø§Ù„ØµØ­ÙŠØ­ØŸ", "Ù…Ø§ Ù‡ÙŠ Ø£Ø±ÙƒØ§Ù† Ø§Ù„ØµÙ„Ø§Ø©ØŸ"];
            }
            if (lowerText.includes("Ø²ÙƒØ§Ø©")) {
                return ["Ù…Ù‚Ø¯Ø§Ø± Ù†ØµØ§Ø¨ Ø§Ù„Ø²ÙƒØ§Ø©", "Ø¹Ù„Ù‰ Ù…Ù† ØªØ¬Ø¨ Ø§Ù„Ø²ÙƒØ§Ø©ØŸ", "Ù…Ø§ Ø§Ù„ÙØ±Ù‚ Ø¨ÙŠÙ† Ø§Ù„Ø²ÙƒØ§Ø© ÙˆØ§Ù„ØµØ¯Ù‚Ø©ØŸ"];
            }
            if (lowerText.includes("ØµÙŠØ§Ù…") || lowerText.includes("Ø±Ù…Ø¶Ø§Ù†")) {
                return ["Ù…Ø§ Ù‡ÙŠ Ù…Ø¨Ø·Ù„Ø§Øª Ø§Ù„ØµÙŠØ§Ù…ØŸ", "Ø£Ø­ÙƒØ§Ù… Ù‚Ø¶Ø§Ø¡ Ø§Ù„ØµÙŠØ§Ù…", "ÙØ¶Ù„ ØµÙŠØ§Ù… Ø±Ù…Ø¶Ø§Ù†"];
            }
            if (lowerText.includes("Ø­Ø¬") || lowerText.includes("Ø¹Ù…Ø±Ø©")) {
                return ["Ø£Ø±ÙƒØ§Ù† Ø§Ù„Ø­Ø¬", "Ø§Ù„ÙØ±Ù‚ Ø¨ÙŠÙ† Ø§Ù„Ø­Ø¬ ÙˆØ§Ù„Ø¹Ù…Ø±Ø©", "Ù…Ø­Ø¸ÙˆØ±Ø§Øª Ø§Ù„Ø¥Ø­Ø±Ø§Ù…"];
            }
            
            return ["Ù…Ø§ Ù‡ÙŠ Ø£Ø±ÙƒØ§Ù† Ø§Ù„Ø¥Ø³Ù„Ø§Ù…ØŸ", "Ù…Ø§ Ù‡ÙŠ Ø£Ø±ÙƒØ§Ù† Ø§Ù„Ø¥ÙŠÙ…Ø§Ù†ØŸ", "ÙØ¶Ù„ Ø§Ù„ØµÙ„Ø§Ø© Ø¹Ù„Ù‰ Ø§Ù„Ù†Ø¨ÙŠ"];
        }

        // Ask suggested question
        function askQuestion(question) {
            userInput.value = question;
            sendMessage();
        }

        // Escape HTML
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // Event Listeners
        userInput.addEventListener('keydown', function(event) {
            if (event.key === 'Enter' && !event.shiftKey) {
                event.preventDefault();
                sendMessage();
            }
        });

        sendBtn.addEventListener('click', function(event) {
            event.preventDefault();
            sendMessage();
        });

        userInput.addEventListener('input', function() {
            this.style.height = 'auto';
            this.style.height = Math.min(this.scrollHeight, 150) + 'px';
        });
    </script>
</body>
</html>
