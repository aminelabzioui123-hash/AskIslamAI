/**
 * Cloudflare Worker - AskIslamAI v3.0 (Ù…Ø¯Ù…Ø¬ Ù…Ø¹ Ù…ØµØ§Ø¯Ø± Ø§Ù„Ù‚Ø±Ø¢Ù† ÙˆØ§Ù„Ø£Ø­Ø§Ø¯ÙŠØ« ÙˆOpenAI)
 */

// ============================
// Ù†Ø¸Ø§Ù… Ø§Ù„Ù…ØµØ§Ø¯Ø± Ø§Ù„Ø¥Ø³Ù„Ø§Ù…ÙŠØ©
// ============================

class IslamicSourcesManager {
    constructor() {
        this.quranURL = 'https://raw.githubusercontent.com/risan/quran-json/refs/heads/main/data/quran.json';
        this.hadithURL = 'https://cdn.jsdelivr.net/gh/fawazahmed0/hadith-api@1/editions';
        this.arabicBooks = {
            'bukhari': 'ØµØ­ÙŠØ­ Ø§Ù„Ø¨Ø®Ø§Ø±ÙŠ',
            'muslim': 'ØµØ­ÙŠØ­ Ù…Ø³Ù„Ù…',
            'abudawud': 'Ø³Ù†Ù† Ø£Ø¨ÙŠ Ø¯Ø§ÙˆØ¯',
            'tirmidhi': 'Ø¬Ø§Ù…Ø¹ Ø§Ù„ØªØ±Ù…Ø°ÙŠ',
            'nasai': 'Ø³Ù†Ù† Ø§Ù„Ù†Ø³Ø§Ø¦ÙŠ',
            'ibnmajah': 'Ø³Ù†Ù† Ø§Ø¨Ù† Ù…Ø§Ø¬Ù‡'
        };
        this.quranCache = null;
    }

    // ØªØ­Ù…ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù‚Ø±Ø¢Ù†
    async loadQuranData() {
        if (this.quranCache) return this.quranCache;
        
        try {
            const response = await fetch(this.quranURL);
            if (!response.ok) throw new Error('ÙØ´Ù„ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù‚Ø±Ø¢Ù†');
            this.quranCache = await response.json();
            return this.quranCache;
        } catch (error) {
            console.error('âŒ ÙØ´Ù„ ØªØ­Ù…ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù‚Ø±Ø¢Ù†:', error);
            return null;
        }
    }

    // Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ø§Ù„ÙƒÙ„Ù…Ø§Øª Ø§Ù„Ù…ÙØªØ§Ø­ÙŠØ©
    extractKeywords(query) {
        const stopWords = ['Ù…Ø§', 'Ù‡Ùˆ', 'Ù‡ÙŠ', 'ÙƒÙŠÙ', 'Ù„Ù…Ø§Ø°Ø§', 'Ù…ØªÙ‰', 'Ø£ÙŠÙ†', 'Ù…Ù†', 'Ù‡Ù„', 
                          'ÙÙŠ', 'Ø¹Ù„Ù‰', 'Ø¹Ù†', 'Ø¥Ù„Ù‰', 'Ø£Ù†', 'Ø£Ùˆ', 'Ùˆ', 'Ù', 'Ù„',
                          'Ø§Ù„', 'Ø­ÙƒÙ…', 'Ù…Ø¹Ù†Ù‰', 'ØªÙØ³ÙŠØ±', 'Ø´Ø±Ø­'];
        
        return query.split(/\s+/)
            .map(w => w.replace(/[ØŸ!ØŒ.]/g, '').trim())
            .filter(w => w.length > 2 && !stopWords.includes(w));
    }

    // Ø§Ù„Ø¨Ø­Ø« ÙÙŠ Ø§Ù„Ù‚Ø±Ø¢Ù†
    async searchInQuran(query, maxResults = 3) {
        const quranData = await this.loadQuranData();
        const keywords = this.extractKeywords(query);
        const results = [];

        if (!quranData || keywords.length === 0) {
            return results;
        }

        try {
            for (const surah of quranData) {
                for (const verse of surah.verses) {
                    const text = `${verse.text} ${verse.translation || ''}`.toLowerCase();
                    let score = 0;

                    for (const keyword of keywords) {
                        if (text.includes(keyword.toLowerCase())) {
                            score += 1;
                        }
                    }

                    if (score > 0) {
                        results.push({
                            surah: surah.name,
                            surahNumber: surah.number,
                            verseNumber: verse.number,
                            verseText: verse.text,
                            translation: verse.translation || '',
                            score: score
                        });
                    }
                }
            }

            return results.sort((a, b) => b.score - a.score).slice(0, maxResults);
        } catch (error) {
            console.error('âŒ Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø¨Ø­Ø« ÙÙŠ Ø§Ù„Ù‚Ø±Ø¢Ù†:', error);
            return [];
        }
    }

    // Ø§Ù„Ø¨Ø­Ø« ÙÙŠ Ø§Ù„Ø£Ø­Ø§Ø¯ÙŠØ«
    async searchInHadith(query, maxResults = 3) {
        const keywords = this.extractKeywords(query);
        if (keywords.length === 0) return [];

        const results = [];
        const searchPromises = [];

        // Ø§Ù„Ø¨Ø­Ø« ÙÙŠ Ø£Ù‡Ù… ÙƒØªØ¨ Ø§Ù„Ø£Ø­Ø§Ø¯ÙŠØ« Ø£ÙˆÙ„Ø§Ù‹
        for (const book of ['bukhari', 'muslim', 'abudawud']) {
            searchPromises.push(
                this.searchInHadithBook(book, keywords)
            );
        }

        try {
            const bookResults = await Promise.allSettled(searchPromises);
            
            bookResults.forEach(result => {
                if (result.status === 'fulfilled' && result.value && result.value.length > 0) {
                    results.push(...result.value);
                }
            });

            return results.sort((a, b) => b.score - a.score).slice(0, maxResults);
        } catch (error) {
            console.error('âŒ Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø¨Ø­Ø« ÙÙŠ Ø§Ù„Ø£Ø­Ø§Ø¯ÙŠØ«:', error);
            return [];
        }
    }

    async searchInHadithBook(bookKey, keywords) {
        try {
            const response = await fetch(`${this.hadithURL}/ara-${bookKey}.min.json`);
            if (!response.ok) return [];

            const data = await response.json();
            const hadiths = data.hadiths || [];
            const bookName = this.arabicBooks[bookKey];
            const results = [];

            for (const hadith of hadiths) {
                if (!hadith || !hadith.text) continue;

                const text = hadith.text.toLowerCase();
                let score = 0;

                for (const keyword of keywords) {
                    const keywordLower = keyword.toLowerCase();
                    if (text.includes(keywordLower)) {
                        score += 1;
                        const occurrences = (text.match(new RegExp(keywordLower, 'g')) || []).length;
                        score += (occurrences - 1) * 0.5;
                    }
                }

                if (score > 0) {
                    results.push({
                        text: hadith.text,
                        book: bookName,
                        hadithNumber: hadith.hadithnumber || '',
                        chapter: hadith.chapter || '',
                        grades: hadith.grades || [],
                        score: score
                    });
                }
            }

            return results.sort((a, b) => b.score - a.score).slice(0, 2);
        } catch (error) {
            console.error(`âŒ Ø®Ø·Ø£ ÙÙŠ ÙƒØªØ§Ø¨ ${bookKey}:`, error);
            return [];
        }
    }

    // Ø¨Ù†Ø§Ø¡ Ø³ÙŠØ§Ù‚ Ø§Ù„Ù…ØµØ§Ø¯Ø± Ù„Ù„Ø¥Ø±Ø³Ø§Ù„ Ø¥Ù„Ù‰ AI
    buildSourcesContext(quranResults, hadithResults) {
        let context = '';
        const sources = [];

        if (quranResults.length > 0) {
            context += "### Ø§Ù„Ø¢ÙŠØ§Øª Ø§Ù„Ù‚Ø±Ø¢Ù†ÙŠØ© Ø°Ø§Øª Ø§Ù„ØµÙ„Ø©:\n\n";
            quranResults.forEach((verse, index) => {
                context += `${index + 1}. **Ø³ÙˆØ±Ø© ${verse.surah}** (Ø¢ÙŠØ© ${verse.verseNumber}):\n`;
                context += `"${verse.verseText}"\n`;
                if (verse.translation) {
                    context += `*Ø§Ù„ØªÙØ³ÙŠØ±:* ${verse.translation}\n`;
                }
                context += '\n';
                
                sources.push(`Ø§Ù„Ù‚Ø±Ø¢Ù† - Ø³ÙˆØ±Ø© ${verse.surah} Ø¢ÙŠØ© ${verse.verseNumber}`);
            });
        }

        if (hadithResults.length > 0) {
            context += "### Ø§Ù„Ø£Ø­Ø§Ø¯ÙŠØ« Ø§Ù„Ù†Ø¨ÙˆÙŠØ© Ø°Ø§Øª Ø§Ù„ØµÙ„Ø©:\n\n";
            hadithResults.forEach((hadith, index) => {
                context += `${index + 1}. **${hadith.book}** (Ø±Ù‚Ù… ${hadith.hadithNumber}):\n`;
                context += `"${hadith.text}"\n`;
                if (hadith.grades && hadith.grades.length > 0) {
                    context += `*Ø¯Ø±Ø¬Ø© Ø§Ù„Ø­Ø¯ÙŠØ«:* ${hadith.grades.join(', ')}\n`;
                }
                context += '\n';
                
                sources.push(`${hadith.book} - Ø­Ø¯ÙŠØ« Ø±Ù‚Ù… ${hadith.hadithNumber}`);
            });
        }

        return { context, sources };
    }
}

// ============================
// Ù…Ø¯ÙŠØ± Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø© ÙˆØ§Ù„Ø°Ø§ÙƒØ±Ø©
// ============================

class ConversationManager {
    constructor() {
        this.chatHistories = new Map();
    }

    // Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø³Ø¬Ù„ Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø© Ø£Ùˆ Ø¥Ù†Ø´Ø§Ø¡ Ø¬Ø¯ÙŠØ¯
    getChatHistory(chatId) {
        if (!this.chatHistories.has(chatId)) {
            this.chatHistories.set(chatId, []);
        }
        return this.chatHistories.get(chatId);
    }

    // Ø¥Ø¶Ø§ÙØ© Ø±Ø³Ø§Ù„Ø© Ø¥Ù„Ù‰ Ø§Ù„Ø³Ø¬Ù„
    addMessage(chatId, role, content) {
        const history = this.getChatHistory(chatId);
        history.push({ role, content, timestamp: Date.now() });
        
        // Ø­ÙØ¸ ÙÙ‚Ø· Ø¢Ø®Ø± 20 Ø±Ø³Ø§Ù„Ø©
        if (history.length > 20) {
            this.chatHistories.set(chatId, history.slice(-20));
        }
    }

    // Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø¢Ø®Ø± Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ Ù„Ù„Ø³ÙŠØ§Ù‚
    getRecentContext(chatId, maxMessages = 6) {
        const history = this.getChatHistory(chatId);
        return history.slice(-maxMessages);
    }

    // Ù…Ø³Ø­ Ø³Ø¬Ù„ Ù…Ø­Ø§Ø¯Ø«Ø©
    clearChatHistory(chatId) {
        this.chatHistories.delete(chatId);
    }
}

// ============================
// Ù†Ø¸Ø§Ù… ØªØµÙ†ÙŠÙ Ø§Ù„Ø£Ø³Ø¦Ù„Ø©
// ============================

class QuestionClassifier {
    constructor() {
        this.islamicKeywords = [
            'Ø§Ù„Ù„Ù‡', 'Ù‚Ø±Ø¢Ù†', 'ØµÙ„Ø§Ø©', 'Ø²ÙƒØ§Ø©', 'ØµÙˆÙ…', 'ØµÙŠØ§Ù…', 'Ø­Ø¬', 'Ø¹Ù…Ø±Ø©',
            'Ø­Ø¯ÙŠØ«', 'Ø³Ù†Ø©', 'ÙÙ‚Ù‡', 'Ø¹Ù‚ÙŠØ¯Ø©', 'Ø¥Ø³Ù„Ø§Ù…', 'Ù…Ø³Ù„Ù…', 'Ø¥ÙŠÙ…Ø§Ù†',
            'Ø³ÙˆØ±Ø©', 'Ø¢ÙŠØ©', 'Ø¯Ø¹Ø§Ø¡', 'Ø°ÙƒØ±', 'Ø³Ø¬ÙˆØ¯', 'Ø±ÙƒÙˆØ¹', 'ÙˆØ¶ÙˆØ¡',
            'Ø·Ù‡Ø§Ø±Ø©', 'Ø­Ù„Ø§Ù„', 'Ø­Ø±Ø§Ù…', 'Ù…Ø¨Ø§Ø­', 'Ù…ÙƒØ±ÙˆÙ‡', 'ÙˆØ§Ø¬Ø¨', 'Ø³Ù†Ø©'
        ];
        
        this.nonIslamicKeywords = [
            'Ø¨Ø±Ù…Ø¬Ø©', 'ÙƒÙˆØ¯', 'python', 'javascript', 'html', 'css',
            'Ø±ÙŠØ§Ø¶Ø©', 'ÙƒØ±Ø©', 'Ù…Ø¨Ø§Ø±Ø§Ø©', 'Ù…ÙˆØ³ÙŠÙ‚Ù‰', 'Ø£ØºÙ†ÙŠØ©', 'ÙÙ†',
            'Ø³ÙŠØ§Ø³Ø©', 'Ø§Ù‚ØªØµØ§Ø¯', 'ØªÙƒÙ†ÙˆÙ„ÙˆØ¬ÙŠØ§', 'Ø¹Ù„ÙˆÙ…', 'ÙÙŠØ²ÙŠØ§Ø¡',
            'Ø·Ø¨Ø®', 'Ø·Ø¹Ø§Ù…', 'Ù…Ø·Ø¹Ù…', 'Ø³ÙŠØ§Ø±Ø©', 'Ø³ÙØ±', 'ØªØ±ÙÙŠÙ‡'
        ];
    }

    classify(question) {
        const q = question.toLowerCase();
        
        // Ø­Ø³Ø§Ø¨ Ø¯Ø±Ø¬Ø§Øª Ù„Ù„ÙƒÙ„Ù…Ø§Øª Ø§Ù„Ø¥Ø³Ù„Ø§Ù…ÙŠØ©
        let islamicScore = 0;
        this.islamicKeywords.forEach(keyword => {
            if (q.includes(keyword)) islamicScore += 2;
        });

        // Ø­Ø³Ø§Ø¨ Ø¯Ø±Ø¬Ø§Øª Ù„Ù„ÙƒÙ„Ù…Ø§Øª ØºÙŠØ± Ø§Ù„Ø¥Ø³Ù„Ø§Ù…ÙŠØ©
        let nonIslamicScore = 0;
        this.nonIslamicKeywords.forEach(keyword => {
            if (q.includes(keyword)) nonIslamicScore += 2;
        });

        // ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ù†ØªÙŠØ¬Ø©
        if (islamicScore > nonIslamicScore) {
            return { 
                isIslamic: true, 
                confidence: Math.min(0.95, islamicScore / 10) 
            };
        } else if (nonIslamicScore > islamicScore) {
            return { 
                isIslamic: false, 
                confidence: Math.min(0.95, nonIslamicScore / 10) 
            };
        } else {
            return { 
                isIslamic: 'uncertain', 
                confidence: 0.5 
            };
        }
    }
}

// ============================
// Ù†Ø¸Ø§Ù… OpenAI API
// ============================

class OpenAIManager {
    constructor(apiKey) {
        this.apiKey = apiKey;
        this.apiURL = 'https://api.openai.com/v1/chat/completions';
    }

    async generateAnswer(messages) {
        try {
            const response = await fetch(this.apiURL, {
                method: 'POST',
                headers: { 
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${this.apiKey}`
                },
                body: JSON.stringify({
                    model: 'gpt-4o-mini',
                    messages: messages,
                    temperature: 0.7,
                    max_tokens: 2000,
                    stream: false
                })
            });

            if (!response.ok) {
                const errorText = await response.text();
                throw new Error(`OpenAI API Error: ${response.status} - ${errorText}`);
            }

            const data = await response.json();
            
            if (!data.choices || !data.choices[0] || !data.choices[0].message) {
                throw new Error('Ø±Ø¯ ØºÙŠØ± ØµØ§Ù„Ø­ Ù…Ù† OpenAI API');
            }

            return data.choices[0].message.content;
        } catch (error) {
            console.error('âŒ Ø®Ø·Ø£ ÙÙŠ OpenAI API:', error);
            throw error;
        }
    }

    // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø³Ø¤Ø§Ù„ Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… AI
    async verifyQuestionWithAI(question) {
        const systemPrompt = `Ø£Ù†Øª Ù…Ø³Ø§Ø¹Ø¯ Ù…ØªØ®ØµØµ ÙÙŠ ØªØµÙ†ÙŠÙ Ø§Ù„Ø£Ø³Ø¦Ù„Ø©.
Ø£Ø¬Ø¨ Ø¨Ø§Ù„Ù„ØºØ© Ø§Ù„Ø¹Ø±Ø¨ÙŠØ© ÙˆØ¨Ø´ÙƒÙ„ JSON ÙÙ‚Ø·:
{
    "is_islamic": boolean,
    "category": string,
    "confidence": number,
    "reason": string
}

ØªØµÙ†ÙŠÙ Ø§Ù„ÙØ¦Ø§Øª:
1. "islamic" - Ø³Ø¤Ø§Ù„ Ø¥Ø³Ù„Ø§Ù…ÙŠ Ø¹Ù† Ø§Ù„Ù‚Ø±Ø¢Ù†ØŒ Ø§Ù„Ø­Ø¯ÙŠØ«ØŒ Ø§Ù„ÙÙ‚Ù‡ØŒ Ø§Ù„Ø¹Ù‚ÙŠØ¯Ø©
2. "general" - Ø³Ø¤Ø§Ù„ Ø¹Ø§Ù… Ø¹Ù† Ø§Ù„Ø¯ÙŠÙ†
3. "non_islamic" - Ø³Ø¤Ø§Ù„ ØºÙŠØ± Ø¥Ø³Ù„Ø§Ù…ÙŠ
4. "uncertain" - ØºÙŠØ± Ù…ØªØ£ÙƒØ¯

Ø§Ù„Ø³Ø¤Ø§Ù„: ${question}`;

        try {
            const response = await this.generateAnswer([
                { role: 'system', content: systemPrompt },
                { role: 'user', content: question }
            ]);

            try {
                const jsonMatch = response.match(/\{[\s\S]*\}/);
                if (jsonMatch) {
                    return JSON.parse(jsonMatch[0]);
                }
            } catch (e) {
                console.error('âŒ ÙØ´Ù„ ØªØ­Ù„ÙŠÙ„ JSON:', e);
            }

            // Ø¥Ø°Ø§ ÙØ´Ù„ ØªØ­Ù„ÙŠÙ„ JSONØŒ Ù†Ø¹ÙˆØ¯ Ù„Ù„ØªØµÙ†ÙŠÙ Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠ
            return {
                is_islamic: true,
                category: 'general',
                confidence: 0.7,
                reason: 'Ù„Ù… ÙŠØªÙ…ÙƒÙ† Ø§Ù„Ù†Ø¸Ø§Ù… Ù…Ù† ØªØ­Ø¯ÙŠØ¯ Ø§Ù„ØªØµÙ†ÙŠÙ Ø¨Ø¯Ù‚Ø©'
            };
        } catch (error) {
            console.error('âŒ Ø®Ø·Ø£ ÙÙŠ Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø³Ø¤Ø§Ù„:', error);
            return {
                is_islamic: true,
                category: 'general',
                confidence: 0.5,
                reason: 'Ø®Ø·Ø£ ÙÙŠ Ù†Ø¸Ø§Ù… Ø§Ù„ØªØµÙ†ÙŠÙ'
            };
        }
    }
}

// ============================
// Cloudflare Worker Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ
// ============================

export default {
    async fetch(request, env) {
        const url = new URL(request.url);
        const corsHeaders = {
            'Access-Control-Allow-Origin': '*',
            'Access-Control-Allow-Methods': 'GET, POST, PUT, DELETE, OPTIONS',
            'Access-Control-Allow-Headers': 'Content-Type, Authorization, x-chat-id',
        };

        // Ù…Ø¹Ø§Ù„Ø¬Ø© Ø·Ù„Ø¨Ø§Øª CORS
        if (request.method === 'OPTIONS') {
            return new Response(null, { headers: corsHeaders });
        }

        // ============ Ø§Ù„Ù…Ø³Ø§Ø±: Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø© API ============
        if (url.pathname === '/api/chat' || url.pathname.endsWith('/api/chat')) {
            try {
                // Ø§Ø³ØªÙ‚Ø¨Ø§Ù„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ù† Ø§Ù„Ø·Ù„Ø¨
                const requestData = await request.json();
                const { 
                    message, 
                    chatId = `chat_${Date.now()}`,
                    mode = 'comprehensive'
                } = requestData;

                if (!message || message.trim().length === 0) {
                    return new Response(JSON.stringify({
                        error: 'Ø§Ù„Ø±Ø³Ø§Ù„Ø© ÙØ§Ø±ØºØ©',
                        success: false
                    }), {
                        status: 400,
                        headers: { ...corsHeaders, 'Content-Type': 'application/json' }
                    });
                }

                // ØªÙ‡ÙŠØ¦Ø© Ø§Ù„Ø£Ù†Ø¸Ù…Ø©
                const sourcesManager = new IslamicSourcesManager();
                const conversationManager = new ConversationManager();
                const questionClassifier = new QuestionClassifier();
                const openaiManager = new OpenAIManager(env.OPENAI_API_KEY);

                // 1. ØªØµÙ†ÙŠÙ Ø§Ù„Ø³Ø¤Ø§Ù„
                let classification = questionClassifier.classify(message);
                
                // 2. Ø¥Ø°Ø§ ÙƒØ§Ù† ØºÙŠØ± Ù…Ø¤ÙƒØ¯ØŒ Ù†Ø³ØªØ®Ø¯Ù… AI Ù„Ù„ØªØ­Ù‚Ù‚
                if (classification.isIslamic === 'uncertain' || classification.confidence < 0.7) {
                    const aiVerification = await openaiManager.verifyQuestionWithAI(message);
                    classification.isIslamic = aiVerification.is_islamic;
                    classification.confidence = aiVerification.confidence;
                }

                // 3. Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ù„Ø³Ø¤Ø§Ù„ ØºÙŠØ± Ø¥Ø³Ù„Ø§Ù…ÙŠØŒ Ù†Ø±ÙØ¶ Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø©
                if (classification.isIslamic === false) {
                    return new Response(JSON.stringify({
                        content: `Ø¹Ø°Ø±Ø§Ù‹ØŒ Ø£Ù†Ø§ Ù…Ø³Ø§Ø¹Ø¯ Ø¥Ø³Ù„Ø§Ù…ÙŠ Ù…ØªØ®ØµØµ ÙÙŠ Ø§Ù„Ø£Ø³Ø¦Ù„Ø© Ø§Ù„Ø´Ø±Ø¹ÙŠØ© ÙÙ‚Ø·.

Ø§Ù„Ø³Ø¤Ø§Ù„ Ø§Ù„Ø°ÙŠ Ø·Ø±Ø­ØªÙ‡ ÙŠØªØ¹Ù„Ù‚ Ø¨Ù€ "${classification.category}" ÙˆÙ‡Ùˆ Ø®Ø§Ø±Ø¬ ØªØ®ØµØµÙŠ.

ÙŠÙ…ÙƒÙ†Ù†ÙŠ Ù…Ø³Ø§Ø¹Ø¯ØªÙƒ ÙÙŠ:
â€¢ ØªÙØ³ÙŠØ± Ø¢ÙŠØ§Øª Ø§Ù„Ù‚Ø±Ø¢Ù† Ø§Ù„ÙƒØ±ÙŠÙ…
â€¢ Ø´Ø±Ø­ Ø§Ù„Ø£Ø­Ø§Ø¯ÙŠØ« Ø§Ù„Ù†Ø¨ÙˆÙŠØ©
â€¢ Ø§Ù„Ø£Ø³Ø¦Ù„Ø© Ø§Ù„ÙÙ‚Ù‡ÙŠØ© ÙˆØ§Ù„Ø¹Ù‚Ø§Ø¦Ø¯ÙŠØ©
â€¢ Ø§Ù„Ø³ÙŠØ±Ø© Ø§Ù„Ù†Ø¨ÙˆÙŠØ© ÙˆØ£Ø®Ù„Ø§Ù‚ Ø§Ù„Ø¥Ø³Ù„Ø§Ù…
â€¢ Ù‚Ø¶Ø§ÙŠØ§ Ø§Ù„Ø£Ø³Ø±Ø© ÙˆØ§Ù„ØªØ±Ø¨ÙŠØ© Ø§Ù„Ø¥Ø³Ù„Ø§Ù…ÙŠØ©`,
                        sources: [],
                        status: 'non_islamic',
                        chatId: chatId
                    }), {
                        headers: { ...corsHeaders, 'Content-Type': 'application/json; charset=utf-8' }
                    });
                }

                // 4. Ø§Ù„Ø¨Ø­Ø« ÙÙŠ Ø§Ù„Ù…ØµØ§Ø¯Ø± Ø§Ù„Ø¥Ø³Ù„Ø§Ù…ÙŠØ©
                const [quranResults, hadithResults] = await Promise.all([
                    sourcesManager.searchInQuran(message),
                    sourcesManager.searchInHadith(message)
                ]);

                // 5. Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ÙˆØ¬ÙˆØ¯ Ù…ØµØ§Ø¯Ø± ÙƒØ§ÙÙŠØ©
                const totalSources = quranResults.length + hadithResults.length;
                if (totalSources === 0) {
                    return new Response(JSON.stringify({
                        content: `âš ï¸ **Ù„Ù… Ø£ØªÙ…ÙƒÙ† Ù…Ù† Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ù…ØµØ§Ø¯Ø± ÙƒØ§ÙÙŠØ© Ù„Ù„Ø¥Ø¬Ø§Ø¨Ø© Ø¹Ù„Ù‰ Ø³Ø¤Ø§Ù„Ùƒ.**

**Ø§Ù„Ø³Ø¤Ø§Ù„:** ${message}

**Ø§Ù„ØªØµÙ†ÙŠÙ:** ${classification.isIslamic ? 'Ø¥Ø³Ù„Ø§Ù…ÙŠ' : 'ØºÙŠØ± Ø¥Ø³Ù„Ø§Ù…ÙŠ'} (Ø«Ù‚Ø©: ${Math.round(classification.confidence * 100)}%)

**ØªÙ„Ù…ÙŠØ­Ø§Øª Ù„Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø¥Ø¬Ø§Ø¨Ø© Ø£ÙØ¶Ù„:**
1. ØªØ£ÙƒØ¯ Ù…Ù† ØµÙŠØ§ØºØ© Ø§Ù„Ø³Ø¤Ø§Ù„ Ø¨Ø§Ù„Ù„ØºØ© Ø§Ù„Ø¹Ø±Ø¨ÙŠØ© Ø§Ù„ÙØµØ­Ù‰
2. Ø§Ø³ØªØ®Ø¯Ù… Ù…ØµØ·Ù„Ø­Ø§Øª Ø¥Ø³Ù„Ø§Ù…ÙŠØ© ÙˆØ§Ø¶Ø­Ø©
3. ØªØ¬Ù†Ø¨ Ø§Ù„Ø£Ø³Ø¦Ù„Ø© Ø§Ù„Ø¹Ø§Ù…Ø© Ø¬Ø¯Ø§Ù‹
4. ÙŠÙ…ÙƒÙ†Ùƒ Ø³Ø¤Ø§Ù„ Ø¹Ù† Ù…ÙˆØ§Ø¶ÙŠØ¹ Ù…Ø«Ù„:
   - Ø§Ù„ØµÙ„Ø§Ø© ÙˆØ£Ø­ÙƒØ§Ù…Ù‡Ø§
   - Ø§Ù„ØµÙŠØ§Ù… ÙˆÙØ¶Ù„Ù‡
   - Ø§Ù„Ø²ÙƒØ§Ø© ÙˆØ´Ø±ÙˆØ·Ù‡Ø§
   - Ø§Ù„Ø­Ø¬ ÙˆÙ…Ù†Ø§Ø³ÙƒÙ‡
   - Ø¢ÙŠØ§Øª Ø§Ù„Ù‚Ø±Ø¢Ù† ÙˆØªÙØ³ÙŠØ±Ù‡Ø§
   - Ø§Ù„Ø£Ø­Ø§Ø¯ÙŠØ« Ø§Ù„Ù†Ø¨ÙˆÙŠØ© ÙˆØ´Ø±Ø­Ù‡Ø§`,
                        sources: [],
                        status: 'insufficient_sources',
                        chatId: chatId
                    }), {
                        headers: { ...corsHeaders, 'Content-Type': 'application/json; charset=utf-8' }
                    });
                }

                // 6. Ø¨Ù†Ø§Ø¡ Ø³ÙŠØ§Ù‚ Ø§Ù„Ù…ØµØ§Ø¯Ø±
                const { context: sourcesContext, sources: allSources } = 
                    sourcesManager.buildSourcesContext(quranResults, hadithResults);

                // 7. Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø³ÙŠØ§Ù‚ Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø© Ø§Ù„Ø³Ø§Ø¨Ù‚Ø©
                const chatHistory = conversationManager.getRecentContext(chatId);
                
                // 8. Ø¨Ù†Ø§Ø¡ Ø±Ø³Ø§Ø¦Ù„ Ø§Ù„Ù†Ø¸Ø§Ù… Ù„Ù„Ù…Ø­Ø§Ø¯Ø«Ø©
                const systemInstructions = {
                    'comprehensive': `Ø£Ù†Øª Ù…Ø³Ø§Ø¹Ø¯ Ø¥Ø³Ù„Ø§Ù…ÙŠ Ø®Ø¨ÙŠØ± ÙŠÙØ¯Ø¹Ù‰ "AskIslamAI". Ù…Ù‡Ù…ØªÙƒ Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø© Ø¹Ù„Ù‰ Ø§Ù„Ø£Ø³Ø¦Ù„Ø© Ø§Ù„Ø¥Ø³Ù„Ø§Ù…ÙŠØ© Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰ Ø§Ù„Ù…ØµØ§Ø¯Ø± Ø§Ù„Ù…ÙˆØ«ÙˆÙ‚Ø© ÙÙ‚Ø·.

## Ø§Ù„ØªØ¹Ù„ÙŠÙ…Ø§Øª Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ©:
1. **ØªØ³ØªØ®Ø¯Ù… ÙÙ‚Ø· Ø§Ù„Ù…ØµØ§Ø¯Ø± Ø§Ù„Ù…Ù‚Ø¯Ù…Ø© Ø£Ø¯Ù†Ø§Ù‡ Ù„Ù„Ø¥Ø¬Ø§Ø¨Ø©.**
2. **Ù„Ø§ ØªØ®ØªØ±Ø¹ Ø¢ÙŠØ§Øª Ù‚Ø±Ø¢Ù†ÙŠØ© Ø£Ùˆ Ø£Ø­Ø§Ø¯ÙŠØ« Ù†Ø¨ÙˆÙŠØ©.**
3. **Ø¥Ø°Ø§ ÙƒØ§Ù†Øª Ø§Ù„Ù…Ø¹Ù„ÙˆÙ…Ø§Øª ØºÙŠØ± ÙƒØ§ÙÙŠØ© ÙÙŠ Ø§Ù„Ù…ØµØ§Ø¯Ø±ØŒ Ø§Ø¹ØªØ±Ù Ø¨Ø°Ù„Ùƒ Ø¨ÙˆØ¶ÙˆØ­.**
4. **Ø£Ø¶Ù ØªØ­Ø°ÙŠØ±Ù‹Ø§ ÙÙŠ Ù†Ù‡Ø§ÙŠØ© ÙƒÙ„ Ø¥Ø¬Ø§Ø¨Ø© Ø¨Ø£Ù†Ù‡Ø§ ØªØ¹Ù„ÙŠÙ…ÙŠØ© ÙˆÙ„ÙŠØ³Øª ÙØªÙˆÙ‰.**
5. **ØªÙ„ØªØ²Ù… Ø¨Ø§Ù„Ù„ØºØ© Ø§Ù„Ø¹Ø±Ø¨ÙŠØ© Ø§Ù„ÙØµØ­Ù‰.**
6. **ØªØ±ØªØ¨ Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø© Ø¨ÙˆØ¶ÙˆØ­ Ù…Ø¹ Ø¹Ù†Ø§ÙˆÙŠÙ† Ù…Ù†Ø§Ø³Ø¨Ø©.**

## Ù…ØµØ§Ø¯Ø± Ø§Ù„Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ù…ØªØ§Ø­Ø©:
${sourcesContext}

## ØªÙˆØ¬ÙŠÙ‡Ø§Øª Ø§Ù„Ù†Ù…Ø·:
- Ø§Ø¨Ø¯Ø£ Ø¨Ø§Ù„Ø¨Ø³Ù…Ù„Ø© (Ø¨Ø³Ù… Ø§Ù„Ù„Ù‡ Ø§Ù„Ø±Ø­Ù…Ù† Ø§Ù„Ø±Ø­ÙŠÙ…).
- Ù‚Ø¯Ù… Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø© ÙÙŠ Ù†Ù‚Ø§Ø· ÙˆØ§Ø¶Ø­Ø© Ø¥Ø°Ø§ ÙƒØ§Ù† Ø°Ù„Ùƒ Ù…Ù†Ø§Ø³Ø¨Ù‹Ø§.
- Ø§Ø´ÙØ± Ø¥Ù„Ù‰ Ø§Ù„Ù…ØµØ§Ø¯Ø± Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…Ø© Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø©.
- Ø§Ø®ØªÙ… Ø¨Ø§Ù„ØªØ­Ø°ÙŠØ± Ø§Ù„Ù…Ø·Ù„ÙˆØ¨.
- Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ù„Ø³Ø¤Ø§Ù„ ÙŠØªØ¹Ù„Ù‚ Ø¨Ø­ÙƒÙ… Ø´Ø±Ø¹ÙŠØŒ ÙˆØ¶Ø­ Ø£Ù† Ù‡Ù†Ø§Ùƒ Ø§Ø®ØªÙ„Ø§ÙØ§Øª Ø¨ÙŠÙ† Ø§Ù„Ù…Ø°Ø§Ù‡Ø¨ Ø¥Ø°Ø§ ÙˆØ¬Ø¯Øª.
- ÙƒÙ† Ø¯Ù‚ÙŠÙ‚Ù‹Ø§ ÙÙŠ Ø§Ù„Ù†Ù‚Ù„ ÙˆÙ„Ø§ ØªØ²ÙŠØ¯ Ø¹Ù„Ù‰ Ø§Ù„Ù†Øµ.`,
                    
                    'concise': `Ø£Ù†Øª Ù…Ø³Ø§Ø¹Ø¯ Ø¥Ø³Ù„Ø§Ù…ÙŠ Ù…ØªØ®ØµØµ. Ù‚Ø¯Ù… Ø¥Ø¬Ø§Ø¨Ø© Ù…Ø®ØªØµØ±Ø© ÙˆÙ…Ø¨Ø§Ø´Ø±Ø© Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰ Ø§Ù„Ù…ØµØ§Ø¯Ø± Ø§Ù„ØªØ§Ù„ÙŠØ© ÙÙ‚Ø·:

${sourcesContext}

**ØªØ¹Ù„ÙŠÙ…Ø§Øª:**
- Ø£Ø¬Ø¨ Ø¨Ø¥ÙŠØ¬Ø§Ø²
- Ø§Ø³ØªØ®Ø¯Ù… Ø§Ù„Ù†Ù‚Ø§Ø· Ø¥Ø°Ø§ Ø£Ù…ÙƒÙ†
- Ø§Ø°ÙƒØ± Ø§Ù„Ù…ØµØ§Ø¯Ø± Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…Ø©
- Ø£Ø¶Ù ØªØ­Ø°ÙŠØ±Ù‹Ø§ ÙÙŠ Ø§Ù„Ù†Ù‡Ø§ÙŠØ©`,
                    
                    'detailed': `Ø£Ù†Øª Ø¹Ø§Ù„Ù… Ø´Ø±Ø¹ÙŠ Ù…ØªØ®ØµØµ. Ù‚Ø¯Ù… Ø¥Ø¬Ø§Ø¨Ø© Ù…ÙØµÙ„Ø© Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰ Ø§Ù„Ù…ØµØ§Ø¯Ø± Ø§Ù„ØªØ§Ù„ÙŠØ©:

${sourcesContext}

**ØªØ¹Ù„ÙŠÙ…Ø§Øª:**
- Ù‚Ø¯Ù… Ø´Ø±Ø­Ù‹Ø§ Ù…ÙØµÙ„Ø§Ù‹ ÙˆØ´Ø§Ù…Ù„Ø§Ù‹
- Ù†Ø§Ù‚Ø´ Ø§Ù„Ø£Ø¯Ù„Ø© ÙˆØ§Ù„Ø¨Ø±Ø§Ù‡ÙŠÙ†
- Ø§Ø°ÙƒØ± Ø¢Ø±Ø§Ø¡ Ø§Ù„Ø¹Ù„Ù…Ø§Ø¡ Ø§Ù„Ù…Ø®ØªÙ„ÙØ©
- Ø£Ø¶Ù ØªØ­Ø°ÙŠØ±Ù‹Ø§ ÙˆØ§Ø¶Ø­Ù‹Ø§ ÙÙŠ Ø§Ù„Ù†Ù‡Ø§ÙŠØ©
- Ù†Ø¸Ù… Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø© ÙÙŠ Ø£Ù‚Ø³Ø§Ù… ÙˆØ§Ø¶Ø­Ø©`
                };

                // 9. Ø¨Ù†Ø§Ø¡ Ø±Ø³Ø§Ø¦Ù„ Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø© Ù„Ù„Ù†Ù…ÙˆØ°Ø¬
                const messagesForAI = [
                    { 
                        role: 'system', 
                        content: systemInstructions[mode] || systemInstructions['comprehensive'] 
                    }
                ];

                // Ø¥Ø¶Ø§ÙØ© ØªØ§Ø±ÙŠØ® Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø© Ø§Ù„Ø³Ø§Ø¨Ù‚
                chatHistory.forEach(msg => {
                    messagesForAI.push({
                        role: msg.role === 'user' ? 'user' : 'assistant',
                        content: msg.content
                    });
                });

                // Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø³Ø¤Ø§Ù„ Ø§Ù„Ø­Ø§Ù„ÙŠ
                messagesForAI.push({ 
                    role: 'user', 
                    content: message 
                });

                // 10. ØªÙˆÙ„ÙŠØ¯ Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø© Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… OpenAI
                const aiResponse = await openaiManager.generateAnswer(messagesForAI);

                // 11. Ø­ÙØ¸ Ø§Ù„Ø±Ø³Ø§Ù„Ø© ÙÙŠ Ø³Ø¬Ù„ Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø©
                conversationManager.addMessage(chatId, 'user', message);
                conversationManager.addMessage(chatId, 'assistant', aiResponse);

                // 12. Ø¥Ø±Ø¬Ø§Ø¹ Ø§Ù„Ø±Ø¯
                return new Response(JSON.stringify({
                    content: aiResponse,
                    sources: allSources,
                    chatId: chatId,
                    status: 'success',
                    sourceCount: {
                        quran: quranResults.length,
                        hadith: hadithResults.length,
                        total: totalSources
                    }
                }), {
                    headers: { ...corsHeaders, 'Content-Type': 'application/json; charset=utf-8' }
                });

            } catch (error) {
                console.error('âŒ Ø®Ø·Ø£ ÙÙŠ Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø©:', error);
                
                return new Response(JSON.stringify({
                    error: 'Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ù…Ø¹Ø§Ù„Ø¬Ø© Ø·Ù„Ø¨Ùƒ',
                    details: error.message,
                    success: false
                }), {
                    status: 500,
                    headers: { ...corsHeaders, 'Content-Type': 'application/json' }
                });
            }
        }

        // ============ Ø§Ù„Ù…Ø³Ø§Ø±: Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø³Ø¬Ù„ Ù…Ø­Ø§Ø¯Ø«Ø© ============
        else if (url.pathname === '/api/history' && request.method === 'GET') {
            try {
                const chatId = request.headers.get('x-chat-id') || url.searchParams.get('chatId');
                
                if (!chatId) {
                    return new Response(JSON.stringify({
                        error: 'Ù…Ø¹Ø±Ù Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø© Ù…Ø·Ù„ÙˆØ¨',
                        success: false
                    }), {
                        status: 400,
                        headers: { ...corsHeaders, 'Content-Type': 'application/json' }
                    });
                }

                const conversationManager = new ConversationManager();
                const history = conversationManager.getChatHistory(chatId);

                return new Response(JSON.stringify({
                    chatId: chatId,
                    history: history,
                    messageCount: history.length,
                    success: true
                }), {
                    headers: { ...corsHeaders, 'Content-Type': 'application/json; charset=utf-8' }
                });

            } catch (error) {
                console.error('âŒ Ø®Ø·Ø£ ÙÙŠ Ø¬Ù„Ø¨ Ø§Ù„Ø³Ø¬Ù„:', error);
                
                return new Response(JSON.stringify({
                    error: 'Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø¬Ù„Ø¨ Ø³Ø¬Ù„ Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø©',
                    details: error.message,
                    success: false
                }), {
                    status: 500,
                    headers: { ...corsHeaders, 'Content-Type': 'application/json' }
                });
            }
        }

        // ============ Ø§Ù„Ù…Ø³Ø§Ø±: Ù…Ø³Ø­ Ø³Ø¬Ù„ Ù…Ø­Ø§Ø¯Ø«Ø© ============
        else if (url.pathname === '/api/clear' && request.method === 'POST') {
            try {
                const { chatId } = await request.json();
                
                if (!chatId) {
                    return new Response(JSON.stringify({
                        error: 'Ù…Ø¹Ø±Ù Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø© Ù…Ø·Ù„ÙˆØ¨',
                        success: false
                    }), {
                        status: 400,
                        headers: { ...corsHeaders, 'Content-Type': 'application/json' }
                    });
                }

                const conversationManager = new ConversationManager();
                conversationManager.clearChatHistory(chatId);

                return new Response(JSON.stringify({
                    message: 'ØªÙ… Ù…Ø³Ø­ Ø³Ø¬Ù„ Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø© Ø¨Ù†Ø¬Ø§Ø­',
                    chatId: chatId,
                    success: true
                }), {
                    headers: { ...corsHeaders, 'Content-Type': 'application/json; charset=utf-8' }
                });

            } catch (error) {
                console.error('âŒ Ø®Ø·Ø£ ÙÙŠ Ù…Ø³Ø­ Ø§Ù„Ø³Ø¬Ù„:', error);
                
                return new Response(JSON.stringify({
                    error: 'Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ù…Ø³Ø­ Ø³Ø¬Ù„ Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø©',
                    details: error.message,
                    success: false
                }), {
                    status: 500,
                    headers: { ...corsHeaders, 'Content-Type': 'application/json' }
                });
            }
        }

        // ============ Ø§Ù„Ù…Ø³Ø§Ø±: ÙØ­Øµ Ø­Ø§Ù„Ø© Ø§Ù„Ù†Ø¸Ø§Ù… ============
        else if (url.pathname === '/api/status' && request.method === 'GET') {
            try {
                const sourcesManager = new IslamicSourcesManager();
                const quranData = await sourcesManager.loadQuranData();
                
                return new Response(JSON.stringify({
                    status: 'operational',
                    timestamp: new Date().toISOString(),
                    features: {
                        quran: quranData ? 'connected' : 'disconnected',
                        hadith: 'available',
                        ai: env.OPENAI_API_KEY ? 'available' : 'missing_key',
                        memory: 'enabled'
                    },
                    stats: {
                        quranChapters: quranData ? quranData.length : 0,
                        hadithBooks: 6,
                        maxHistory: 20
                    },
                    success: true
                }), {
                    headers: { ...corsHeaders, 'Content-Type': 'application/json; charset=utf-8' }
                });

            } catch (error) {
                console.error('âŒ Ø®Ø·Ø£ ÙÙŠ ÙØ­Øµ Ø§Ù„Ø­Ø§Ù„Ø©:', error);
                
                return new Response(JSON.stringify({
                    status: 'degraded',
                    timestamp: new Date().toISOString(),
                    error: error.message,
                    success: false
                }), {
                    status: 500,
                    headers: { ...corsHeaders, 'Content-Type': 'application/json' }
                });
            }
        }

        // ============ Ø§Ù„Ù…Ø³Ø§Ø±: ØªÙ‚Ø¯ÙŠÙ… Ø§Ù„Ù…Ù„ÙØ§Øª HTML Ø§Ù„Ø«Ø§Ø¨ØªØ© ============
        else {
            try {
                // ØªÙ‚Ø¯ÙŠÙ… Ø§Ù„Ù…Ù„ÙØ§Øª Ø§Ù„Ø«Ø§Ø¨ØªØ© Ù…Ù† KV Ø£Ùˆ R2 (Ø¥Ø°Ø§ ÙƒØ§Ù† Ù„Ø¯ÙŠÙƒ)
                // Ø£Ùˆ ÙŠÙ…ÙƒÙ†Ùƒ ØªÙ‚Ø¯ÙŠÙ… ØµÙØ­Ø© Ø§ÙØªØ±Ø§Ø¶ÙŠØ©
                
                if (url.pathname === '/' || url.pathname === '/index.html') {
                    const htmlContent = `
<!DOCTYPE html>
<html>
<head>
    <title>AskIslamAI - Ø§Ù„Ù…Ø³Ø§Ø¹Ø¯ Ø§Ù„Ø¥Ø³Ù„Ø§Ù…ÙŠ Ø§Ù„Ø°ÙƒÙŠ</title>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            text-align: center;
            background: linear-gradient(135deg, #0a5f4f 0%, #1a4a3d 50%, #2d8b74 100%);
            color: white;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
        }
        .logo {
            font-size: 3rem;
            margin-bottom: 1rem;
        }
        h1 {
            font-size: 2.5rem;
            margin-bottom: 1rem;
        }
        p {
            font-size: 1.2rem;
            line-height: 1.6;
            margin-bottom: 2rem;
        }
        .api-info {
            background: rgba(255, 255, 255, 0.1);
            padding: 20px;
            border-radius: 10px;
            margin-top: 2rem;
            text-align: left;
        }
        .endpoints {
            text-align: left;
            background: rgba(255, 255, 255, 0.05);
            padding: 15px;
            border-radius: 8px;
            margin-top: 20px;
        }
        code {
            background: rgba(255, 255, 255, 0.1);
            padding: 2px 6px;
            border-radius: 4px;
            font-family: monospace;
        }
    </style>
</head>
<body>
    <div class="logo">â˜ª</div>
    <h1>AskIslamAI Worker</h1>
    <p>Ù…Ø³Ø§Ø¹Ø¯ Ø¥Ø³Ù„Ø§Ù…ÙŠ Ø°ÙƒÙŠ ÙŠØ¹ØªÙ…Ø¯ Ø¹Ù„Ù‰ Ø§Ù„Ù‚Ø±Ø¢Ù† ÙˆØ§Ù„Ø³Ù†Ø© Ø§Ù„Ù†Ø¨ÙˆÙŠØ©</p>
    
    <div class="api-info">
        <h2>ğŸŒ API Endpoints</h2>
        
        <div class="endpoints">
            <h3>ğŸ”¸ Ø¥Ø±Ø³Ø§Ù„ Ø±Ø³Ø§Ù„Ø©</h3>
            <p><strong>POST</strong> <code>/api/chat</code></p>
            <pre>
{
    "message": "Ø³Ø¤Ø§Ù„Ùƒ Ù‡Ù†Ø§",
    "chatId": "chat_123",
    "mode": "comprehensive|concise|detailed"
}
            </pre>
        </div>

        <div class="endpoints">
            <h3>ğŸ”¸ Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø³Ø¬Ù„ Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø©</h3>
            <p><strong>GET</strong> <code>/api/history?chatId=chat_123</code></p>
            <p>Ø£Ùˆ Ø§Ø³ØªØ®Ø¯Ù… header: <code>x-chat-id: chat_123</code></p>
        </div>

        <div class="endpoints">
            <h3>ğŸ”¸ Ù…Ø³Ø­ Ø³Ø¬Ù„ Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø©</h3>
            <p><strong>POST</strong> <code>/api/clear</code></p>
            <pre>
{
    "chatId": "chat_123"
}
            </pre>
        </div>

        <div class="endpoints">
            <h3>ğŸ”¸ ÙØ­Øµ Ø­Ø§Ù„Ø© Ø§Ù„Ù†Ø¸Ø§Ù…</h3>
            <p><strong>GET</strong> <code>/api/status</code></p>
        </div>
    </div>
</body>
</html>`;
                    
                    return new Response(htmlContent, {
                        headers: {
                            'Content-Type': 'text/html; charset=utf-8',
                            ...corsHeaders
                        }
                    });
                }

                // Ø¥Ø°Ø§ Ù„Ù… ÙŠÙƒÙ† Ø§Ù„Ù…Ø³Ø§Ø± Ù…Ø¹Ø±ÙˆÙØ§Ù‹ØŒ Ù†Ø±Ø¬Ø¹ Ø®Ø·Ø£ 404
                return new Response('Ø§Ù„ØµÙØ­Ø© ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯Ø©', {
                    status: 404,
                    headers: {
                        'Content-Type': 'text/plain; charset=utf-8',
                        ...corsHeaders
                    }
                });

            } catch (error) {
                return new Response(`Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø®Ø§Ø¯Ù…: ${error.message}`, {
                    status: 500,
                    headers: {
                        'Content-Type': 'text/plain; charset=utf-8',
                        ...corsHeaders
                    }
                });
            }
        }
    }
};
